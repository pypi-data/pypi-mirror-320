stages:
  - publish

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

Build container image:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --cache --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG

Publish to PyPI:
  stage: publish
  image: python:3.13-slim-bookworm
  rules:
    - if: $CI_COMMIT_TAG
  cache:
    paths:
      - .cache/pip
  before_script:
    - pip install -U build twine
  script:
    - python -m build
    # TWINE_USERNAME and TWINE_PASSWORD env variables are defined in https://git.nomics.world/groups/dbnomics/-/settings/ci_cd
    - twine upload dist/*
  environment:
    name: PyPI
    url: https://pypi.org/project/dbnomics-fetcher-ops/$CI_COMMIT_TAG
