"use strict";(self.webpackChunktvb_ext_unicore=self.webpackChunktvb_ext_unicore||[]).push([[496],{496:(e,t,a)=>{a.r(t),a.d(t,{default:()=>U});var s=a(161),n=a(594);const o="NONE",r="text/plain";function i(e){return`from tvb_ext_unicore.unicore_wrapper import unicore_wrapper\nunicore = unicore_wrapper.UnicoreWrapper()\njob = unicore.get_job('${e}')\njob`}var l=a(101),c=a(228),d=a(345),u=a.n(d),m=a(355),g=a(262),h=a(597),p=a(358);async function b(e="",t={}){const a=p.ServerConnection.makeSettings(),s=h.URLExt.join(a.baseUrl,"tvb_ext_unicore",e);let n;console.log("req URL: ",s);try{n=await p.ServerConnection.makeRequest(s,t,a)}catch(e){throw new p.ServerConnection.NetworkError(e)}let o=await n.text();if(o.length>0)try{o=JSON.parse(o)}catch(e){console.log("Not a JSON response body.",n)}if(!n.ok)throw new p.ServerConnection.ResponseError(n,o.message||o);return o}var S=a(53);const E=e=>{const[t,a]=(0,d.useState)(null),[s,n]=(0,d.useState)("");return(0,d.useEffect)((()=>{b(`job_output?job_url=${encodeURIComponent(e.job_url)}`).then((e=>a(e))).catch((e=>{console.log("err: ",e),n(e.message)}))}),[]),u().createElement("tr",{className:"outputFiles","data-testid":`output-${e.job_url}`},t?u().createElement("td",{colSpan:100},u().createElement("p",{className:"unicoreMessage"},s),"Output Files:",Object.entries(t).map((([t,a])=>u().createElement(w,{output:t,outputType:a,key:`${t}`,jobUrl:e.job_url,jobId:e.jobId,getFileBrowser:e.getFileBrowser,getKernel:e.getKernel})))):u().createElement("td",{colSpan:100},s?u().createElement("p",{className:"unicoreMessage"},s):u().createElement("div",{className:"loadingRoot"},u().createElement("span",{className:"unicoreLoading"}))))},w=e=>{const{output:t,outputType:a,jobUrl:s,getFileBrowser:o,jobId:i}=e,[l,c]=(0,d.useState)(!1),h={success:"unicoreMessage-success",warning:"unicoreMessage-warning",error:"unicoreMessage"},[p,E]=(0,d.useState)({text:"",className:h.success});let w;async function f(e){let t=e=e.replace("/","");if(["stdout","stderr","UNICORE_SCRIPT_EXIT_CODE"].includes(t)&&(t=`${e}_${i}`),function(e){const t=o().model.items();return(0,S.some)(t,((t,a)=>t.name===e))}(t)&&!await async function(e){return(await(0,n.showDialog)({title:"File already exists!",body:`If you continue the file ${e}} will be re downloaded and overwritten!`,buttons:[n.Dialog.cancelButton({label:"Cancel"}),n.Dialog.okButton({label:"Continue"})]})).button.accept}(t))return;const a=o(),r=a.model.path;console.log("File browser path: ",r);const l={job_url:s,in_file:e,path:r,out_file:t};try{c(!0);const t=await b(`drive/${encodeURIComponent(s)}/${e}`,{method:"POST",body:JSON.stringify(l)});console.log("response: ",t),E({text:t.message,className:h[t.status]}),c(!1),a.update()}catch(e){await(0,n.showErrorMessage)("Error on request:",e);const t=e instanceof Error?e.message:"An unexpected error occurred";E({text:t,className:h.error}),c(!1)}}async function v(e){await f(t),y()}function y(){o().node.removeEventListener("drop",v),null==w||w.dispose()}return u().createElement("div",{className:"unicore-jobOutput","data-testid":`output-${t}`},a.is_file?u().createElement("i",{className:"fa fa-file"}):u().createElement("i",{className:"fas fa-folder"}),u().createElement("p",{draggable:!0,className:"outputFileName",onDragStart:async function(e){o().node.addEventListener("drop",v);const a=`from tvb_ext_unicore.unicore_wrapper import unicore_wrapper\nunicore = unicore_wrapper.UnicoreWrapper()\ndownload_result = unicore.download_file('${s}', '${t}')\ndownload_result`;w=new m.Drag({mimeData:new g.MimeData,supportedActions:"copy",proposedAction:"copy",source:t}),w.mimeData.setData(r,a),w.start(e.clientX,e.clientY).then((e=>{console.log("r: ",e),y()}))}},t),a&&u().createElement(u().Fragment,null,u().createElement("span",{className:p.className},p.text),l?u().createElement("div",{className:"loadingRoot"},u().createElement("span",{className:"unicoreLoading"})):u().createElement("i",{"data-testid":"download-file",className:"fa fa-download clickableIcon",onClick:()=>f(t),onKeyDown:e=>{"Enter"===e.key&&f(t)},tabIndex:0})))},f=e=>u().createElement("table",null,u().createElement(v,{columns:e.columns}),u().createElement(y,{buttonSettings:e.buttonSettings,columns:e.columns,data:e.data,setMessageState:e.setMessageState,getKernel:e.getKernel,getJob:e.getJob,handleError:e.handleError,getFileBrowser:e.getFileBrowser,afterButtonSettingClick:e.afterButtonSettingClick})),v=e=>u().createElement("thead",null,u().createElement("tr",null,e.columns.map((e=>u().createElement("td",{key:e,className:e},e.toUpperCase()))),u().createElement("td",null,"ACTIONS"))),y=e=>u().createElement("tbody",null,e.data.map((t=>u().createElement(C,{key:t.id,id:t.id,cols:e.columns,job:t,buttonSettings:e.buttonSettings,setMessageState:e.setMessageState,getKernel:e.getKernel,getJob:e.getJob,handleError:e.handleError,getFileBrowser:e.getFileBrowser,afterButtonSettingClick:e.afterButtonSettingClick})))),C=e=>{const[t,a]=(0,d.useState)(!1),[s,n]=(0,d.useState)(!1);return u().createElement(u().Fragment,null,u().createElement("tr",{onClick:()=>n(!s),draggable:"true",onDragStart:async function(t){var a;if(!await e.getKernel())return void e.handleError("Current kernel can't be used to handle this operation!");const s=e.getJob(e.job.resource_url),n=new m.Drag({mimeData:new g.MimeData,supportedActions:"copy",proposedAction:"copy",dragImage:null===(a=document.getElementById(`${e.job.id}`))||void 0===a?void 0:a.cloneNode(!0),source:e.job});n.mimeData.setData(r,s),n.start(t.clientX,t.clientY).then((e=>console.log("r: ",e)))},"data-testid":`table-row-${e.job.id}`},e.cols.map(((t,a)=>u().createElement("td",{key:`${e.job.id}-${a}`},e.job[t]))),t?u().createElement("td",null,u().createElement("div",{className:"loadingRoot"},u().createElement("span",{className:"unicoreLoading"}))):u().createElement("td",null,e.job.is_cancelable&&!t&&u().createElement("button",{onClick:function(t){t.stopPropagation(),a(!0),e.buttonSettings.onClick(...e.buttonSettings.onClickFieldArgs.map((t=>e.job[t]))).then((t=>{e.afterButtonSettingClick().then((()=>a(!1))),e.setMessageState(t.message)}))}},"Cancel Job"))),s&&u().createElement(u().Fragment,null,u().createElement(E,{job_url:e.job.resource_url,getFileBrowser:e.getFileBrowser,getKernel:e.getKernel,jobId:e.job.id}),u().createElement("tr",{className:"detailsRow"},u().createElement("td",{colSpan:100},u().createElement("textarea",{value:e.job.logs.join("\n"),readOnly:!0})))))},_=e=>u().createElement("div",{className:"unicorePagination","data-testid":"pagination-component"},u().createElement("div",null,u().createElement("div",{className:"btnLeftContainer"},e.showPrevButton&&u().createElement("button",{onClick:function(){e.setPageState(e.currentPage-1)},"data-testid":"p-btn-left"},u().createElement("i",{className:"fa fa-arrow-left"}))),u().createElement("div",{className:"currentPageContainer"},u().createElement("span",null,`Page: ${e.currentPage}`)),u().createElement("div",{className:"btnRightContainer"},e.showNextButton&&u().createElement("button",{onClick:function(){e.setPageState(e.currentPage+1)},"data-testid":"p-btn-right"},u().createElement("i",{className:"fa fa-arrow-right"})))));function R({onToggle:e,initialCheckedState:t,label:a}){const[s,n]=(0,d.useState)(t);return u().createElement("div",null,u().createElement("input",{id:"auto-refresh",type:"checkbox",checked:s,onChange:t=>{n(t.target.checked),e(t.target.checked)}}),a&&u().createElement("label",{htmlFor:"auto-refresh"},a))}const k=e=>{const[t,a]=(0,d.useState)(!1);return u().createElement("div",{className:"pyunicoreSites","data-testid":"pyunicore-sites"},u().createElement("div",null,u().createElement("span",null,"SITE:"),u().createElement("select",{onChange:function(t){e.onChangeSite(t.target.value)},disabled:e.disableSelection,"data-testid":"select",defaultValue:e.defaultSite},e.sites.map((e=>u().createElement("option",{key:e,id:e,value:e},e))))),u().createElement("button",{className:`refreshBtn ${t&&"spin"}`,onClick:()=>{a(!0),setTimeout((()=>a(!1)),500),e.refreshSite()},disabled:e.loading},u().createElement("i",{className:"fa fa-refresh"})),u().createElement(R,{onToggle:e.setAutoReload,initialCheckedState:!0,label:"Auto refresh"}))};var N;!function(e){e.Warning="WARNING",e.Error="ERROR",e.Success="SUCCESS",e.Confirm="CONFIRM"}(N||(N={}));const j=e=>u().createElement("div",{className:"unicoreModal",style:{display:e.visible?"flex":"none"},"data-testid":"modal-widget"},u().createElement("div",null,u().createElement("div",null,u().createElement("h3",null,e.modalType)),u().createElement("div",null,u().createElement("p",null,String(e.message))),u().createElement("div",null,u().createElement("button",{onClick:()=>e.setVisible(!1)},"CLOSE"))));class x extends n.ReactWidget{constructor(e){super(),this.addClass("tvb-pyunicoreWidget"),this.props=e}render(){return u().createElement(F,{tableFormat:this.props.tableFormat,data:this.props.data,buttonSettings:this.props.buttonSettings,sites:this.props.sites,defaultSite:this.props.defaultSite,reloadRate:6e4,getKernel:this.props.getKernel,getJobCode:this.props.getJobCode,getFileBrowser:this.props.getFileBrowser})}}class F extends u().Component{constructor(e){super(e),this._triggerUpdate=(e=!1)=>{this.state.site!==o&&(e||this.state.autoReload&&(new Date).valueOf()-this.state.lastUpdate.valueOf()>=this.state.reloadRate&&!this.state.loading)&&this.setState((e=>({...e,isRefresh:!0})))},this.setPageState=this.setPageState.bind(this),this.setSiteState=this.setSiteState.bind(this),this.setModalSateVisible=this.setModalSateVisible.bind(this),this.getData=this.getData.bind(this),this.catchError=this.catchError.bind(this),this.setAutoReload=this.setAutoReload.bind(this);const t=new Date;this.state={jobs:[],message:e.data.message,site:e.defaultSite,buttonSettings:e.buttonSettings,tableFormat:e.tableFormat,reloadRate:6e4,loading:e.sites.length>0,sites:e.sites,page:1,itemsPerPage:10,lastUpdate:t,renderLeftArrow:!1,renderRightArrow:!1,disableSitesSelection:!0,modalState:{modalType:N.Error,message:"",visible:!1,setVisible:this.setModalSateVisible},autoReload:!0,isRefresh:!1,updateIntervalId:0}}_getEndpoint(){return`jobs?site=${this.state.site}&page=${this.state.page}`}async getData(){this.setState((e=>({...e,loading:!0,renderLeftArrow:!1,renderRightArrow:!1,disableSitesSelection:!0})));const e=await b(this._getEndpoint());return this.setState((t=>({...t,jobs:e.jobs,message:e.message,loading:!1,lastUpdate:new Date,renderLeftArrow:t.page>1,renderRightArrow:e.jobs.length>=t.itemsPerPage,disableSitesSelection:!1,isRefresh:!1}))),e}setPageState(e){this.setState((t=>({...t,page:e})))}setModalSateVisible(e){this.setState((t=>({...t,loading:!1,renderLeftArrow:!0,renderRightArrow:!0,disableSitesSelection:!1,modalState:{...t.modalState,visible:e}})))}setSiteState(e){this.setState((t=>({...t,page:1,site:e,jobs:e===o?[]:t.jobs})))}setAutoReload(e){this.setState((t=>({...t,autoReload:e})))}componentDidUpdate(e,t){if((this.state.isRefresh&&!t.isRefresh||t.page!==this.state.page||t.site!==this.state.site)&&this.state.sites.length>0){if(this.state.site===o)return void this.setState((e=>({...e,loading:!1,disableSitesSelection:!1,jobs:[],renderLeftArrow:!1,renderRightArrow:!1,isRefresh:!1})));this.getData().catch(this.catchError)}}catchError(e){this.setState((t=>({...t,modalState:{...t.modalState,visible:!0,message:e}})))}componentWillUnmount(){const{updateIntervalId:e}=this.state;("number"==typeof e||"object"==typeof e&&null!==e)&&clearInterval(e)}componentDidMount(){const e=setInterval(this._triggerUpdate,1e4);this.setState({...this.state,updateIntervalId:e}),this.state.site!==o?this.state.sites.length<=0||this.getData().catch(this.catchError):this.setState((e=>({...e,loading:!1,disableSitesSelection:!1})))}render(){return u().createElement(u().Fragment,null,u().createElement(j,{modalType:this.state.modalState.modalType,message:this.state.modalState.message,visible:this.state.modalState.visible,setVisible:this.state.modalState.setVisible}),u().createElement("div",{className:"unicoreTopBar"},u().createElement(_,{setPageState:this.setPageState,showNextButton:this.state.renderRightArrow,showPrevButton:this.state.renderLeftArrow,currentPage:this.state.page}),u().createElement(k,{sites:this.state.sites,onChangeSite:this.setSiteState,defaultSite:this.state.site,disableSelection:this.state.disableSitesSelection,refreshSite:()=>this._triggerUpdate(!0),loading:this.state.loading,setAutoReload:this.setAutoReload}),this.state.loading?u().createElement("div",null,u().createElement("div",{className:"loadingRoot"},u().createElement("span",{className:"unicoreLoading"}))):u().createElement("div",null,u().createElement("span",{className:"unicoreMessage"},this.state.message),u().createElement("span",{className:"lastUpdate"},"Last update: ",this.state.lastUpdate.toLocaleTimeString()))),u().createElement(f,{buttonSettings:this.state.buttonSettings,afterButtonSettingClick:this.getData,columns:this.state.tableFormat.cols,data:this.state.jobs,setMessageState:e=>{this.setState((t=>({...t,message:e})))},getKernel:this.props.getKernel,getJob:this.props.getJobCode,handleError:this.catchError,getFileBrowser:this.props.getFileBrowser}))}}var I=a(948),B=a(256);class A extends B.Widget{constructor(e){super(e),this._labShell=e.labShell,this._command=e.command,this._commands=e.commandRegistry,this._area=e.area,this._shellOptions=e.shellOptions,this.title.icon=e.icon,this.title.caption=e.caption,this.id=e.id?e.id:"tvb-ext-unicore-side-btn",this.title.className=this.id}addToLabShell(){this._labShell.add(this,this._area,this._shellOptions)}async onAfterShow(e){console.log("after show"),super.onAfterShow(e);const t=m.Drag.overrideCursor("wait");await this._click(),t.dispose()}async _click(){switch(this._area){case"left":this._labShell.collapseLeft();break;case"right":this._labShell.collapseRight()}await this._commands.execute(this._command)}}var D=a(960),P=a(338);async function T(e){const t={resource_url:e};return b("jobs",{method:"POST",body:JSON.stringify(t)})}const U={id:"tvb_ext_unicore:plugin",autoStart:!0,requires:[n.ICommandPalette,s.ILayoutRestorer,I.IConsoleTracker,s.ILabShell,c.INotebookTracker,l.IFileBrowserFactory,P.ISettingRegistry],activate:async(e,t,a,s,r,l,c,d)=>{let u;console.log("JupyterLab extension tvb-ext-unicore is activated!");const m=["id","name","owner","site","status","start_time"],g="tvb_ext_unicore:open";console.log("SettingRegistry:",d),await d.load("tvb-ext-unicore:settings").then((e=>{console.log("Settings loaded:",e.composite);const t=e.get("registry").composite;console.log(`Registry: ${t}`)})).catch((e=>{console.error("Failed to load settings:",e)})),e.commands.addCommand(g,{label:"PyUnicore Task Stream",execute:async(t={defaultSite:o})=>{if(!u||u.isDisposed){let e,a,d=[];try{e=await b("sites"),d=[...Object.keys(e.sites)],a=function(e,t){return e!==o&&null!=e?t.includes(e)?e:((0,n.showErrorMessage)("SITE ERROR",`Site ${e} is not available at this time! Available sites: ${t}`),o):o}(t.defaultSite,d)}catch(e){return void await(0,n.showErrorMessage)("ERROR","Unicore seems to be down at the moment. Please check service availability and try again later.")}const g=new x({tableFormat:{cols:m,idField:"id",buttonRenderConditionField:"is_cancelable"},data:{message:e.message,jobs:[]},buttonSettings:{onClick:T,onClickFieldArgs:["resource_url"],isAsync:!1,name:"Cancel Job"},sites:[o,...d],defaultSite:a,reloadRate:6e4,getKernel:async()=>{const e=M.getCurrentKernel(r,l,s);return await M.shouldUseKernel(e)?e:null},getJobCode:i,getFileBrowser:()=>M.getFileBrowser(c)});u=new n.MainAreaWidget({content:g}),u.id="tvb_ext_unicore",u.title.label="PyUnicore Task Stream",u.title.closable=!0}h.has(u)||h.add(u),u.isAttached||e.shell.add(u,"main"),e.shell.activateById(u.id)}}),t.addItem({command:g,category:"PyUnicore"});const h=new n.WidgetTracker({namespace:"pyunicore"}),p=new D.LabIcon({name:"unicoreIcon",svgstr:'<?xml version="1.0" standalone="no"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"\n "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">\n<svg version="1.0" xmlns="http://www.w3.org/2000/svg"\n width="37.000000pt" height="45.000000pt" viewBox="0 0 37.000000 45.000000"\n preserveAspectRatio="xMidYMid meet">\n\n<g transform="translate(7.000000,35.000000) scale(0.0700000,-0.0700000)"\nfill="#616161" stroke="none">\n<path d="M2 373 c3 -144 6 -173 22 -200 28 -46 83 -73 148 -73 72 0 117 25\n145 80 21 40 23 58 23 202 l0 158 -40 0 -40 0 0 -160 c0 -157 -1 -161 -25\n-185 -17 -18 -35 -25 -62 -25 -80 1 -93 31 -93 219 l0 151 -41 0 -41 0 4 -167z"/>\n<path d="M10 25 l0 -25 165 0 165 0 0 25 0 25 -165 0 -165 0 0 -25z"/>\n</g>\n</svg>\n'});new A({command:g,commandRegistry:e.commands,labShell:r,caption:"PyUnicore Tasks Stream",icon:p,area:"right",shellOptions:{rank:10}}).addToLabShell(),a.restore(h,{command:g,name:()=>"pyunicore"})}};var M;!function(e){e.shouldUseKernel=async function(e){if(!e)return!1;const t=await e.spec;return!!t&&-1!==t.language.toLowerCase().indexOf("python")},e.getCurrentKernel=function(e,t,a){var s,n,o,r;let i,l=e.currentWidget;return l&&t.has(l)?i=null===(s=l.sessionContext.session)||void 0===s?void 0:s.kernel:l&&a.has(l)?i=null===(n=l.sessionContext.session)||void 0===n?void 0:n.kernel:t.currentWidget?(l=t.currentWidget,i=null===(o=l.sessionContext.session)||void 0===o?void 0:o.kernel):a.currentWidget&&(l=a.currentWidget,i=null===(r=l.sessionContext.session)||void 0===r?void 0:r.kernel),i},e.getFileBrowser=function(e){return e.createFileBrowser("default")}}(M||(M={}))}}]);