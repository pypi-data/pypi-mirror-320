
sentiment_positif = {
    "3jbni": 0.7, "7bit": 0.9, "7ebit": 0.7, "nadi": 0.8, "zwin": 0.7,"zouin":0.7,"zine":0.7,"mo3tabar":0.8,"fri3":0.8,"rfi3":0.8,"fr7an":0.6,"lkhr":0.8,"ra2i3":0.8,"modhil":0.8,"ani9":0.6,"sa3id":0.7,
    "wa3r": 8.0,"Zaynab":100, "naadia": 0.7, "mfrge3a": 8.0, "ghzal": 1.0 , "makhaybch": 0.4 ,"nadiya":0.8, "nadia":0.8 , "mana9ssach":0.4,"matay7ach":0.4,"herban":0.8,"kay7eme9":0.8,'kay7m9ni':0.8, "jdida":0.4,"fniwn":5
}

sentiment_negatif = {
    "ma3jbnich": -0.7, "ma7ebitch": -0.9, "khayb": -7.0, "na9ess": -0.7,"ma7ebitouch":-0.6,
    "7amed": -0.6, "fachel": -1.0, "probleme": -0.8, "mochkil": -0.9,
    "khasr": -0.7, "habta": -0.8, "ma7meltoch": -0.9 ,"tay7a" : -0.7 , "mazwinch" :-0.6,"mazouinch":-0.6 , "manadiyach":-0.6,"manadiach":-0.6,"mawa3rach":-0.4, "3iyan":-0.7,"frya":-0.7,"9dim":0.4
}

datapositif ={'bogos': 0.5,'3aamr': 0.35,
 'jdid': 0.1363636363636363,
 '9dim': 0.1,
 'charf': 0.1,
 'sa8l': 0.4333333333333333,
 '7a9i9ia': 0.2,
 '3adi': 0.15,
 'gadd': 0.2,
 'nachT': 0.8,
 'n9i': 0.3666666666666667,
 '3aadil': 0.7,
 'ghany': 0.375,
 'Tabi3i': 0.1,
 'mch8our': 0.6,
 'fr7an': 0.5,
 'dourijin': 0.375,
 'Dakhm': 0.4000000000000001,
 'za8i': 0.4,
 'fakhour': 0.8,
 'raDi': 0.5,
 'mrta7': 0.4,
 'mchghoul': 0.1,
 'kalm': 0.3,
 'Drief': 0.2,
 'choja3': 0.8,
 'za3em': 0.8,
 'dki': 0.8,
 '7akim': 0.7,
 'komik': 0.25,
 '7amla': 0.3333333333333333,
 'ijabi': 0.2272727272727272,
 'waa9i3i': 0.1666666666666666,
 'm39ol': 0.2,
 'waaD7': 0.1,
 'rkhiS': 0.4,
 'zwin': 0.25,
 '3aDim': 0.4,
 'jtima3i': 0.0333333333333333,
 'mo8im': 0.4,
 '3aali': 0.5,
 'waas3': 0.2142857142857142,
 '3aamm': 0.05,
 'chaabb': 0.1,
 'mo7ddad': 0.1666666666666666,
 'mojoud': 0.4,
 'bkri': 0.1,
 'asaasi': 0.1666666666666666,
 'ra2isi': 0.0625,
 '9tiSadi': 0.2,
 'mo2kkad': 0.5,
 'm2kked': 0.2142857142857142,
 'mo3yyan': 0.2142857142857142,
 'momyyaz': 0.3571428571428571,
 'kollchi': 0.2,
 '7orr': 0.4,
 'S7i7': 0.4333333333333333,
 'chdid': 0.4333333333333333,
 '9aanouni': 0.2,
 '7adit': 0.2,
 'mzyan': 0.4166666666666667,
 'mo3tabar': 0.1,
 'monaasib': 0.5,
 'naaj7': 0.75,
 'wa3i': 0.1,
 'mi8ani': 0.3,
 'mobachir': 0.1,
 'mofid': 0.3,
 'f33al': 0.6,
 'wajd': 0.2,
 'ms2oul': 0.2,
 'kaml': 0.1,
 'skhoun': 0.25,
 'awwali': 0.4,
 '9wi': 0.5,
 'momtaz': 0.3333333333333333,
 'Tri': 0.3,
 'b3id': 0.1,
 'ta9afi': 0.1,
 'aamin': 0.5,
 'bzzaf': 0.2,
 'dafi': 0.6,
 'mola2im': 0.55,
 'm7bob': 0.5,
 't3limi': 0.25,
 'sri3': 0.2,
 'm2lof': 0.375,
 'mitaali': 1.0,
 'mSro3': 1.0,
 'bayn': 0.05,
 'mDwwi': 0.7000000000000001,
 'jddab': 0.8,
 '7ayawi': 0.1363636363636363,
 '8amaji': 0.1,
 'mtisse3': 0.0625,
 'ra2i3': 0.4,
 'mitali': 0.9,
 'naadir': 0.3,
 'mo3aSir': 0.1666666666666666,
 'kbir': 0.5,
 'bo7do': 0.375,
 '7yy': 0.1,
 'mz8ar': 0.3333333333333333,
 'da8abi': 0.3,
 '7ibbi': 0.375,
 '7ssas': 0.1,
 'monasib': 0.4,
 'Si77i': 0.5,
 'ml7ouD': 0.5,
 'mota2lli9': 0.9,
 'moTla9': 0.2,
 'adabi': 0.1,
 'khaaliS': 0.2142857142857142,
 'aSiil': 0.4,
 'mofDDal': 0.5,
 '7lo': 0.35,
 'mkhtalf': 0.3,
 'tay9': 0.5,
 'mtnas9': 0.5,
 'goud': 0.2,
 'bard': 0.35,
 '7eyy': 0.125,
 'las9': 0.4000000000000001,
 'fo9 l3ada': 0.3333333333333333,
 'khari9 lil3ada': 0.3333333333333333,
 'nazih': 0.6,
 'd9i9': 0.4,
 'mles': 0.4,
 '9rib': 0.1,
 'waD7': 0.25,
 'momti3': 0.5,
 'klasiki': 0.1666666666666666,
 'mobdi3': 0.5,
 'loghawi': 0.1,
 'taabt': 0.1666666666666666,
 'fikri': 0.3,
 'tjribi': 0.1,
 'kayt3awd': 0.1,
 'mcharji': 0.2,
 '7add': 0.6,
 'mnTi9i': 0.25,
 'mtwaD3': 0.1,
 'bDDbT': 0.25,
 '3ryan': 0.05,
 'mamtwe99e3ch': 0.1,
 'barii2': 0.5,
 '8a2il': 0.3333333333333333,
 'mobaachir': 0.375,
 'mod8il': 0.6,
 'mtfowwe9': 0.7,
 '2aamin': 0.4,
 'raa9i': 0.5,
 'mlmous': 0.15,
 'si7ri': 0.5,
 'kayD77ek': 0.3,
 'mitli': 0.4166666666666667,
 '2aamn': 0.25,
 'tamiin': 0.5,
 'ghali': 0.5,
 'fnni': 0.3333333333333333,
 'khfif': 0.3333333333333333,
 'mj88d': 0.1,
 'Tamou7': 0.25,
 'naDj': 0.1,
 'mt3aaTf': 0.5,
 'mt7mmes': 0.6,
 '3ami9': 0.0833333333333333,
 'mokhliS': 0.3333333333333333,
 'nabil': 0.6,
 'mfSSl': 0.5,
 'm7DouD': 0.4,
 'mo288al': 0.5,
 'za3m': 0.3333333333333333,
 'mo7taram': 0.5,
 'tabt': 0.5,
 'wagf': 0.5,
 'akhla9i': 0.2,
 'fchkel': 0.5,
 'gharib': 0.5,
 'msta9ll': 0.4,
 'automatic': 0.4,
 'mlwwen': 0.3,
 'bnin': 1.0,
 'kayfrre7': 1.0,
 '7amimi': 0.2,
 'tlkhdma': 0.3,
 'takhayyoli': 0.6,
 '3ajib': 0.4,
 'mrtajl': 0.6,
 'makaytSnne3ch': 0.6,
 'mobtakar': 0.5,
 '3amali': 0.6,
 'makattnsach': 0.5,
 'mo8oub': 0.7,
 'aSli': 0.5,
 'moD7ik': 0.25,
 'komidi': 0.25,
 'm9boul': 0.5,
 'mo3awin': 0.5,
 'wa3r': 0.5,
 'mch8or': 0.5,
 'laa2i9': 0.1666666666666666,
 '7rayfi': 0.5,
 'jbbar': 0.4,
 'ldid': 1.0,
 'mberrer': 0.4,
 'mol8im': 0.5,
 'stitna2i': 0.6666666666666666,
 'mti99en': 0.5}

datanegatif={'DaSr': -0.15,
 'modmin': -0.4,
 'ghabyy': -0.7999999999999999,
 'mkllkh': -0.7999999999999999,
 'mjllj': -0.7999999999999999,
 'Sghir': -0.25,
 'm8rrs': -0.4,
 'momill': -0.2916666666666667,
 'r9i9': -0.4,
 'khayb': -0.6999999999999998,
 '8bil': -0.6,
 'mSTTi': -0.6,
 'S3ib': -0.2,
 '9as7': -0.2,
 'm3TTl': -0.3,
 'm399d': -0.3,
 't9il': -0.2,
 'was3': -0.5,
 'fa9ir': -0.4,
 'khayf': -0.6,
 '7azin': -0.5,
 'mskin': -1.0,
 'ghDban': -0.625,
 '7chman': -0.5,
 'wa7id': -0.0714285714285714,
 'mchoki': -0.7,
 'mrwwn': -0.4,
 '3yyan': -0.4,
 'anani': -0.5,
 'm3gaz': -0.25,
 'fDoli': -0.1,
 'mtwaD3': -0.2,
 '3abiT': -0.5,
 'nyya': -0.3,
 'silbi': -0.3,
 'tay3yyef': -1.0,
 '3ma': -0.5,
 'mj8oul': -0.1,
 'mojrim': -0.4,
 'ghali': -0.5,
 'lkhrin': -0.125,
 'sghir': -0.1875,
 'Twil': -0.05,
 'neSS': -0.1666666666666666,
 'mochtarak': -0.3,
 'cha2i3': -0.3,
 '3aazib': -0.0714285714285714,
 'ajnabi': -0.125,
 'khaT2': -0.4000000000000001,
 'm39ol': -0.3333333333333333,
 'saabi9': -0.1666666666666666,
 'myyet': -0.2,
 'mt2ssef': -0.5,
 '7rbi': -0.1,
 'mDllem': -0.15,
 'bard': -0.6,
 'm2louf': -0.25,
 'nachT': -0.1333333333333333,
 'mosta7il': -0.6666666666666666,
 '3adi': -0.25,
 'magaddch': -0.5,
 'mo3ddal': -0.15,
 'ghrib': -0.05,
 '39li': -0.1,
 'khaTir': -0.6,
 'mamo7tamalch': -0.5,
 'khaD3': -0.1666666666666666,
 'radd lbal': -0.5,
 'khawi': -0.1,
 'damawi': -0.8,
 'namoudaji': -0.1666666666666666,
 'mDyye9': -0.2,
 '9aaser': -0.05,
 'mamo8immch': -0.05,
 'ra8ib': -1.0,
 'mriD': -0.7142857142857143,
 'ghliD': -0.3,
 'taanawi': -0.3,
 'fchkel': -0.1666666666666666,
 '7aadd': -0.125,
 'modnib': -0.5,
 '3orfi': -0.1428571428571428,
 'dramatiki': -0.4333333333333333,
 'msTT7': -0.025,
 'D3if': -0.5,
 'sirri': -0.4,
 'fazg': -0.1,
 'Saarim': -0.2,
 'mojrrad': -0.5,
 'a9Saa': -0.125,
 'ba8t': -0.5,
 'kaykhle3': -1.0,
 'm8moum': -0.25,
 '9lil': -0.1666666666666666,
 '3an bo3d': -0.1,
 'Sari7': -0.2142857142857142,
 'b3id': -0.1,
 '3anif': -0.8,
 'mdwwer': -0.2,
 'mossekh': -0.6,
 'mrkhi': -0.0769230769230769,
 'fa9d l2amal': -0.6,
 'ghayr 9anoni': -0.5,
 'khaam': -0.2307692307692307,
 'morr': -0.1,
 '3chwa2i': -0.5,
 'mzyyer': -0.1785714285714285,
 'ms2oul': -0.1,
 'yawmi': -0.2,
 'mSTane3': -0.6,
 'machi 3aadil': -0.5,
 'mo2lim': -0.7,
 'm9lle9': -0.6,
 'maDarorich': -0.4,
 'mabaynch': -0.3333333333333333,
 'joz2i': -0.1,
 'kay3yyef': -1.0,
 'momyyiz': -0.0666666666666666,
 '7ssas': -0.3,
 'mo2sif': -0.5,
 'makayt9adach': -0.125,
 'mo7rij': -0.6,
 'khbit': -1.0,
 'chirrir': -1.0,
 'sT7i': -0.3333333333333333,
 'm3nfj': -0.5,
 'mamori7ch': -0.5,
 '9aasi': -1.0,
 'w7chi': -1.0,
 'kham': -0.7,
 'mamofri7ch': -0.6499999999999999,
 'm3awd': -0.2,
 'zayd': -0.2,
 '8aawi': -0.25,
 'm2sawi': -0.75,
 'mofji3': -0.75,
 'ortodoxi': -0.2,
 'mt3SSeb': -0.2,
 'kaariti': -0.7,
 '3tibaaTyan': -0.1,
 'gharib': -0.5,
 'mam2ddebch': -0.3,
 'mamrbbich': -0.3,
 'mt7mmes': -0.05,
 'mtwetter': -0.3333333333333333,
 'ka2ib': -1.0,
 'kay9tel': -0.2,
 'kayfrchekh': -0.6,
 '9bi7': -1.0,
 'msbiTr': -0.6,
 'motaw99a3': -0.2,
 'mtna9D': -0.5,
 'sad': -0.1,
 'mesdoud': -0.1,
 'ghaleT': -0.5,
 'mkhbbi': -0.1666666666666666}

def merge_dicts(dict1, dict2):
  merged = dict1.copy()
  merged.update(dict2)
  return merged

bigdatapositif=merge_dicts(datapositif, sentiment_positif)
bigdatanegatif=merge_dicts(datanegatif, sentiment_negatif)

negate_words = ["machi", "machy", "mchi", "mashi", "maxi","mechi","mechy"]
    # Mots qui annulent l'effet de négation quand ils suivent machi
cancel_negation_words = ["ghir","ghr",'gha', "ghire","ghere","ghi", "ghyr", "gher"]

intensifiers = {
        "bzf": 1.5, "bzaf": 1.5, "bzaaf": 1.5, "bzef": 1.5, "bezaf": 1.5,
        "bazaf": 1.5, "bzff": 1.5, "ktir": 1.3, "keteer": 1.3,
        "chwiya": 0.7, "chwia": 0.7, "chouia": 0.7, "choia": 0.7,
        "kamel": 1.4, "bla9iyass": 1.6, "bela9ias": 1.6, "mout": 1.8, "moot": 1.8
            }

def sentiment_analysis8(l, sentimentpositif, sentimentnegatif):
    """
    Analyse les sentiments dans des textes darija avec gestion des inversions, fautes d'orthographe,
    et intensificateurs. Gestion spéciale de 'machi ghir'.
    """
    lq = []  # Liste pour les tweets positifs
    lp = []  # Liste pour les tweets négatifs
    lr = []  # Liste pour les tweets neutres




    def is_negated(word_index, words):
        """
        Vérifie si un mot est sous l'influence d'une négation.
        Prend en compte le cas spécial où 'machi' est suivi par 'ghir' ou ses variantes.
        """
        for i in range(max(0, word_index - 3), word_index):
            if words[i] in negate_words:
                # Vérifier si le mot suivant la négation est un mot qui annule l'effet
                next_idx = i + 1
                if next_idx < len(words):
                    # Chercher des correspondances approximatives pour les mots qui annulent
                    cancel_matches = find_similar_brands(words[next_idx],
                                                       cancel_negation_words,
                                                       threshold=0.7)
                    if cancel_matches:
                        # Si on trouve un mot qui annule, on ignore cette négation
                        continue
                return True
        return False

    def get_intensifier_multiplier(words, sentiment_index):
        """
        Calcule le multiplicateur d'intensité en cherchant les intensificateurs après le mot de sentiment.
        """
        multiplier = 1.0
        # Chercher dans les 2 mots suivant le mot de sentiment
        for i in range(sentiment_index + 1, min(sentiment_index + 3, len(words))):
            matches = find_similar_brands(words[i], list(intensifiers.keys()), threshold=0.7)
            if matches:
                matched_intensifier = matches[0]['matched_brand']
                multiplier *= intensifiers[matched_intensifier]
        return multiplier

    for text in l:
        if not text.strip():  # Ignorer les textes vides
            continue

        words = text.split()
        score = 0

        # Parcourir chaque mot
        for word_index, word in enumerate(words):
            # Vérifier la négation
            is_neg = is_negated(word_index, words)

            # Vérifier les sentiments positifs
            matches_pos = find_similar_brands(word, list(sentimentpositif.keys()), threshold=0.7)
            for match in matches_pos:
                matched_word = match['matched_brand']
                # Obtenir le multiplicateur en vérifiant les mots qui suivent
                multiplier = get_intensifier_multiplier(words, word_index)
                word_score = sentimentpositif[matched_word] * multiplier
                score += -word_score if is_neg else word_score

            # Vérifier les sentiments négatifs
            matches_neg = find_similar_brands(word, list(sentimentnegatif.keys()), threshold=0.8)
            for match in matches_neg:
                matched_word = match['matched_brand']
                # Obtenir le multiplicateur en vérifiant les mots qui suivent
                multiplier = get_intensifier_multiplier(words, word_index)
                word_score = sentimentnegatif[matched_word] * multiplier
                score += -word_score if is_neg else word_score

        # Classification selon le score
        if score > 0:
            lq.append((text, score))
        elif score < 0:
            lp.append((text, score))
        else:
            lr.append((text, score))

    return lq, lp, lr

def ratio(p,n,r):
  somme=len(p)+len(n)+len(r)
  return len(p)/somme,len(n)/somme,len(r)/somme

def sentiment_analysis_darija(sentences):
  return sentiment_analysis8(sentences,bigdatapositif,bigdatanegatif)