import{r as m,g as oe,j as e,c as h,i as E,v as A,f as Fe,b as C,a as S,m as N,I as q,B as R,l as _,aj as Ie,H as V,S as Z,P as le,a6 as je,a7 as ze,a8 as Ae,ak as Ee,_ as Qe,d as Te,s as Oe,e as Be,q as He,F as z,D as We,a9 as $e,al as Ge}from"./index-6816c2e2.js";import{u as G,M as Ve}from"./project-6467db80.js";import{S as be}from"./SplitPane-02b33a55.js";import{E as $,M as qe}from"./file-0d9727e9.js";import{u as j}from"./editor-455eeb7f.js";import{I as w}from"./Input-c7035747.js";import{X as Ue,L as Ye}from"./ListboxShow-5bc4ae7c.js";import{B as we}from"./Banner-c05e071d.js";import{r as k,T as de}from"./Tab-aed8edbf.js";import{g as ue,G as Xe,F as Je,T as Ze}from"./help-448810e5.js";import{M as Ke,u as Se,a as ie,b as es,c as ss,C as ts}from"./context-494f181e.js";import{v as ne,M as ls,P as ns}from"./PlusCircleIcon-4b5f221b.js";import{D as rs}from"./ReportErrors-0402cda7.js";import"./transition-7382842e.js";import"./index-c3a63b93.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./help-68063aae.js";import"./SourceList-0d5c3942.js";import"./pluralize-0dfcc89b.js";function as({title:s,titleId:t,...l},a){return m.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:a,"aria-labelledby":t},l),s?m.createElement("title",{id:t},s):null,m.createElement("path",{fillRule:"evenodd",d:"M3 6.75A.75.75 0 013.75 6h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 6.75zM3 12a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 12zm0 5.25a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75a.75.75 0 01-.75-.75z",clipRule:"evenodd"}))}const os=m.forwardRef(as),Ce=os;function is({title:s,titleId:t,...l},a){return m.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:a,"aria-labelledby":t},l),s?m.createElement("title",{id:t},s):null,m.createElement("path",{fillRule:"evenodd",d:"M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z",clipRule:"evenodd"}))}const cs=m.forwardRef(is),ds=cs;function us({title:s,titleId:t,...l},a){return m.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:a,"aria-labelledby":t},l),s?m.createElement("title",{id:t},s):null,m.createElement("path",{d:"M15 3.75H9v16.5h6V3.75zM16.5 20.25h3.375c1.035 0 1.875-.84 1.875-1.875V5.625c0-1.036-.84-1.875-1.875-1.875H16.5v16.5zM4.125 3.75H7.5v16.5H4.125a1.875 1.875 0 01-1.875-1.875V5.625c0-1.036.84-1.875 1.875-1.875z"}))}const ms=m.forwardRef(us),fs=ms;function xs(s){switch(s){case $.SQL:return"SQL";case $.PY:return"Python";case $.YAML:case $.YML:return"YAML";default:return"Plain Text"}}function hs(s,t){return s.file.extension===$.SQL&&s.file.isLocal&&oe(t)}const L=function({text:t,children:l,className:a}){return e.jsxs("small",{className:h("font-bold whitespace-nowrap text-xs",a),children:[E(t)&&e.jsxs("span",{children:[t,": "]}),l]})};function ps({text:s,className:t}){return e.jsx("span",{className:h("font-normal",t),children:s})}function gs({ok:s,className:t}){return e.jsx("span",{className:h("inline-block w-2 h-2 rounded-full",A(s)&&"bg-warning-500",Fe(s)&&"bg-success-500",C(s)&&"bg-danger-500",t)})}L.Text=ps;L.Light=gs;const I={Model:"model",Test:"test",Audit:"audit",Macro:"macro",Hook:"hook",Log:"log",Config:"config",Seed:"seed",Metric:"metric",Schema:"schema",Unknown:"unknown"};function vs({tab:s}){const t=S(o=>o.isModel),l=j(o=>o.engine),a=j(o=>o.dialects),d=j(o=>o.refreshTab);m.useEffect(()=>{var c;const o=(c=a[0])==null?void 0:c.dialect_name;A(s.dialect)&&E(o)&&i(o)},[a,s]);function i(o){s.dialect=o,d(s),l.postMessage({topic:"dialect",payload:s.dialect})}return e.jsxs("div",{className:"flex w-full items-center px-2 min-h-[2rem] overflow-hidden",children:[s.file.isRemote&&e.jsx(L,{className:"mr-2",text:"Saved",children:e.jsx(L.Light,{ok:C(s.file.isChanged)})}),s.file.isRemote&&s.file.isSQL&&e.jsx(L,{className:"mr-2",text:"Formatted",children:e.jsx(L.Light,{ok:s.file.isFormatted})}),e.jsx(L,{className:"mr-2",text:"Language",children:e.jsx(L.Text,{text:xs(s.file.extension)})}),hs(s,a)&&e.jsx(L,{className:"mr-2",text:"Dialect",children:e.jsx(w,{size:N.sm,children:({className:o,size:c})=>e.jsx(w.Selector,{className:o,size:c,list:a.map(p=>({text:p.dialect_title,value:q(p.dialect_name)?"sqlglot":p.dialect_name})),onChange:i,value:s.dialect})})}),t(s.file.path)&&!q(s.dialect)&&e.jsx(L,{className:"mr-2",text:"Dialect",children:e.jsx(L.Text,{text:s.dialect})}),e.jsx(L,{className:"mr-2",text:"SQLMesh Type",children:e.jsx(L.Text,{text:js(s.file.path)})})]})}function js(s){return q(s)?I.Unknown:s.startsWith("models")?I.Model:s.startsWith("tests")?I.Test:s.startsWith("logs")?I.Log:s.startsWith("macros")?I.Macro:s.startsWith("hooks")?I.Hook:s.startsWith("seeds")?I.Seed:s.startsWith("metrics")?I.Metric:["config.yaml","config.yml","config.py"].includes(s)?I.Config:["external_models.yaml","schema.yaml"].includes(s)?I.Schema:I.Unknown}function Ne({tab:s,title:t}){const l=m.useRef(null),a=S(v=>v.addConfirmation),d=G(v=>v.setSelectedFile),i=j(v=>v.closeTab),o=j(v=>v.tab),c=s.file.id===(o==null?void 0:o.file.id);return m.useEffect(()=>{A(s)||(s.el=l.current??void 0)},[l,s]),m.useEffect(()=>{A(o)||setTimeout(()=>{var v;(v=o.el)==null||v.scrollIntoView({behavior:"smooth",inline:"center"})},300)},[o]),e.jsx("li",{ref:l,className:h("inline-block py-1 pr-2 last-child:pr-0 overflow-hidden text-center overflow-ellipsis cursor-pointer"),onClick:p,children:e.jsxs("span",{className:h("flex border-2 justify-between items-center pl-1 pr-1 py-[0.125rem] min-w-[8rem] rounded-md group border-transparent border-r border-r-theme-darker dark:border-r-theme-lighter",c?"bg-neutral-200 border-neutral-200 text-neutral-900 dark:bg-dark-lighter dark:border-dark-lighter dark:text-primary-500":"bg-trasparent hover:bg-theme-darker dark:hover:bg-theme-lighter"),children:[e.jsx("small",{className:"text-xs",children:t}),e.jsx("small",{className:h("group-hover:hidden text-xs inline-block ml-3 mr-1 w-2 h-2 rounded-full",s.file.isChanged?"bg-warning-500":"bg-transparent")}),e.jsx(Ue,{className:"hidden group-hover:inline-block text-neutral-600 dark:text-neutral-100 w-4 h-4 ml-2 mr-0 cursor-pointer",onClick:n})]})});function p(v){v.stopPropagation(),d(s.file)}function n(v){v.stopPropagation(),f()}function f(){s.file.isChanged?a({headline:"Closing Tab",description:"All unsaved changes will be lost. Do you want to close the tab anyway?",yesText:"Yes, Close Tab",noText:"No, Cancel",action:()=>i(s.file)}):i(s.file)}}function bs(){const s=S(r=>r.modules),t=S(r=>r.models),l=S(r=>r.lastSelectedModel),a=S(r=>r.setLastSelectedModel),d=G(r=>r.files),i=G(r=>r.selectedFile),o=G(r=>r.setSelectedFile),c=j(r=>r.tab),p=j(r=>r.tabs),n=j(r=>r.replaceTab),f=j(r=>r.createTab),v=j(r=>r.selectTab),P=j(r=>r.addTab),[g,y]=m.useMemo(()=>{const r=[],T=[];return p.forEach(x=>{x.file.isLocal&&r.push(x),x.file.isRemote&&T.push(x)}),[r,T]},[p]);return m.useEffect(()=>{if(A(i)||(c==null?void 0:c.file)===i||i instanceof Ve||C(s.hasFiles))return;a(t.get(i.path));const r=f(i);E(c)&&c.file instanceof qe&&C(c.file.isChanged)&&c.file.isRemote&&C(p.has(i))?n(c,r):P(r),v(r)},[i,s]),m.useEffect(()=>{if(A(l))return;const r=d.get(l.path);A(r)||o(r)},[l]),e.jsxs("div",{className:"flex items-center bg-neutral-5",children:[e.jsx(R,{className:"h-6 m-0 ml-1 mr-2 border-none",variant:_.Alternative,size:N.sm,onClick:F,children:e.jsx(ds,{className:"inline-block w-3 h-4"})}),e.jsxs("ul",{className:"w-full whitespace-nowrap min-h-[2rem] max-h-[2rem] overflow-hidden overflow-x-auto hover:scrollbar scrollbar--horizontal",children:[g.map((r,T)=>e.jsx(Ne,{tab:r,title:`Custom SQL ${T+1}`},r.id)),y.map(r=>e.jsx(Ne,{tab:r,title:r.file.name},r.id))]})]});function F(r){r.stopPropagation(),b()}function b(){const r=f();P(r),v(r),o(r.file)}}const ye=24*60*60*1e3,ws=1e3,J=50;function Ns({tab:s,isOpen:t=!0,toggle:l}){const a=S(o=>o.models),d=S(o=>o.isModel),i=m.useMemo(()=>a.get(s.file.path),[s,a]);return e.jsx("div",{className:h("flex flex-col w-full h-full items-center overflow-hidden"),children:d(s.file.path)?E(i)&&e.jsx(ys,{tab:s,model:i,isOpen:t,toggle:l}):e.jsx(Es,{tab:s,isOpen:t,toggle:l})})}function ys({tab:s,model:t,isOpen:l=!0,toggle:a}){const d=S(c=>c.environment),i=S(c=>c.environments),o=Array.from(i).filter(({isRemote:c})=>c).map(({name:c})=>({text:c,value:c}));return e.jsxs(k.Group,{children:[e.jsxs("div",{className:"flex w-full items-center",children:[e.jsx(R,{className:h("h-6 w-6 !px-0 border-none bg-neutral-10 dark:bg-neutral-20",l?"text-secondary-500 dark:text-secondary-300":"text-neutral-500 dark:text-neutral-300"),variant:_.Info,size:N.sm,onClick:c=>{c.stopPropagation(),a==null||a()},children:e.jsx(Ce,{className:"w-4 h-4"})}),l&&e.jsx(de,{className:"flex justify-center items-center",list:["Evaluate","Columns",o.length>1&&d.isRemote&&"Diff"].filter(Boolean)})]}),l&&e.jsxs(k.Panels,{className:"h-full w-full overflow-hidden",children:[e.jsx(k.Panel,{unmount:!1,className:h("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(Cs,{model:t})}),e.jsx(k.Panel,{unmount:!1,className:"text-xs w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 px-2",children:e.jsx(Ke,{nodeId:t.fqn,columns:t.columns,disabled:C(t.isModelSQL),withHandles:!1,withSource:!1,withDescription:!0,limit:10})}),o.length>1&&d.isRemote&&e.jsx(k.Panel,{unmount:!1,className:h("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(Ps,{tab:s,model:t,list:o.filter(({value:c})=>d.name!==c),target:{text:d.name,value:d.name}})})]})]})}function Es({tab:s,isOpen:t=!0,toggle:l}){return e.jsxs(k.Group,{children:[e.jsxs("div",{className:"flex w-full items-center",children:[e.jsx(R,{className:h("h-6 w-6 !px-0 border-none bg-neutral-10 dark:bg-neutral-20",t?"text-secondary-500 dark:text-secondary-300":"text-neutral-500 dark:text-neutral-300"),variant:_.Info,size:N.sm,onClick:a=>{a.stopPropagation(),l==null||l()},children:e.jsx(Ce,{className:"w-4 h-4"})}),t&&e.jsx(de,{className:"flex justify-center items-center",list:["Run Query","Diff"]})]}),t&&e.jsxs(k.Panels,{className:"h-full w-full overflow-hidden",children:[e.jsx(k.Panel,{unmount:!1,className:h("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(Ss,{tab:s})}),e.jsx(k.Panel,{unmount:!1,className:h("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(ks,{})})]})]})}function Ts({children:s}){return e.jsx("fieldset",{className:"flex my-3",children:s})}function K({children:s}){return e.jsx("div",{className:"flex w-full h-full py-1 overflow-hidden overflow-y-auto hover:scrollbar scrollbar--vertical",children:s})}function ee({children:s}){return e.jsx("div",{className:"flex w-full py-1 px-1 justify-end",children:s})}function Ss({tab:s}){const t=j(p=>p.setPreviewQuery),l=j(p=>p.setPreviewTable),a=j(p=>p.engine),{refetch:d,isFetching:i,cancel:o}=Ie({sql:s.file.content});m.useEffect(()=>()=>{o()},[]);function c(){l(void 0),t(s.file.content),d().then(({data:p})=>{l(ue(p))})}return e.jsxs(e.Fragment,{children:[e.jsx(K,{}),e.jsx(V,{}),e.jsxs(ee,{children:[e.jsx(R,{size:N.sm,variant:_.Alternative,onClick:p=>{p.stopPropagation(),a.postMessage({topic:"format",payload:{sql:s.file.content,dialect:s.dialect}})},children:"Format"}),i?e.jsxs("div",{className:"flex items-center",children:[e.jsx(Z,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Running Query..."}),e.jsx(R,{size:N.sm,variant:_.Danger,onClick:p=>{p.stopPropagation(),o()},children:"Cancel"})]}):e.jsx(R,{size:N.sm,variant:_.Alternative,disabled:i,onClick:p=>{p.stopPropagation(),c()},children:"Run Query"})]})]})}function Cs({model:s}){const t=S(g=>g.environment),l=S(g=>g.isModel),a=j(g=>g.setPreviewQuery),d=j(g=>g.setPreviewTable),[i,o]=m.useState({model:s.displayName,start:le(je(Date.now()-ye)),end:le(new Date),execution_time:le(je(Date.now()-ye)),limit:1e3}),{refetch:c}=ze({model:i.model,start:i.start,end:i.end,execution_time:i.execution_time,dialect:s.dialect,pretty:!0}),{refetch:p,isFetching:n,cancel:f}=Ae(i),v=l(s.path)&&Object.values(i).every(Boolean);m.useEffect(()=>()=>{f()},[]);function P(){a(void 0),d(void 0),c().then(({data:g})=>{a(g==null?void 0:g.sql)}),p().then(({data:g})=>{d(ue(g))})}return e.jsxs(e.Fragment,{children:[e.jsx(K,{children:e.jsxs("form",{className:"w-full",children:[C(v)&&e.jsx(Ts,{children:e.jsx(we,{variant:_.Warning,children:e.jsxs(we.Description,{className:"w-full mr-2 text-sm",children:["Please fill out all fields to ",e.jsx("b",{children:"evaluate the model"}),"."]})})}),e.jsxs("fieldset",{className:"px-2 w-full text-neutral-500",children:[e.jsx(w,{className:"w-full mx-0",label:"Start Date",size:N.sm,children:({className:g})=>e.jsx(w.Textfield,{className:h(g,"w-full"),placeholder:"02/11/2023",value:i.start,onInput:y=>{y.stopPropagation(),o({...i,start:y.target.value??""})}})}),e.jsx(w,{className:"w-full mx-0",label:"End Date",size:N.sm,children:({className:g})=>e.jsx(w.Textfield,{className:h(g,"w-full"),placeholder:"02/13/2023",value:i.end,onInput:y=>{y.stopPropagation(),o({...i,end:y.target.value??""})}})}),e.jsx(w,{className:"w-full mx-0",label:"Execution Time",size:N.sm,children:({className:g})=>e.jsx(w.Textfield,{className:h(g,"w-full"),placeholder:"02/13/2023",value:i.execution_time,onInput:y=>{y.stopPropagation(),o({...i,execution_time:y.target.value??""})}})}),E(i.limit)&&e.jsx(w,{className:"w-full mx-0",label:"Limit",size:N.sm,children:({className:g})=>e.jsx(w.Textfield,{className:h(g,"w-full"),type:"number",placeholder:"1000",value:i.limit,onInput:y=>{y.stopPropagation(),o({...i,limit:y.target.valueAsNumber??ws})}})})]})]})}),e.jsx(V,{}),e.jsx(ee,{children:e.jsx("div",{className:"flex w-full justify-end",children:l(s.path)&&n?e.jsxs("div",{className:"flex items-center",children:[e.jsx(Z,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Evaluating..."}),e.jsx(R,{size:N.sm,variant:_.Danger,onClick:g=>{g.stopPropagation(),f()},children:"Cancel"})]}):e.jsx(R,{size:N.sm,variant:_.Alternative,disabled:C(v)||n||t.isInitialProd,onClick:g=>{g.stopPropagation(),P()},children:"Evaluate"})})})]})}function Ps({tab:s,model:t,list:l,target:a}){const d=S(x=>x.isModel),i=j(x=>x.setPreviewDiff),[o,c]=m.useState(l[0].value),[p,n]=m.useState(J),[f,v]=m.useState(""),[P,g]=m.useState(""),{refetch:y,isFetching:F,cancel:b}=Ee({source:o,target:a.value,model_or_snapshot:t.name,limit:p,on:f,where:P}),r=m.useCallback(()=>{i(void 0),y().then(({data:x})=>{i(x)})},[t.name,t.hash]);m.useEffect(()=>()=>{b()},[]),m.useEffect(()=>{c(l[0].value)},[l]);const T=d(s.file.path)&&[o,a,p].every(Boolean);return e.jsxs(e.Fragment,{children:[e.jsx(K,{children:e.jsx("form",{className:"w-full",children:e.jsxs("fieldset",{className:"px-2 w-full text-neutral-500",children:[e.jsx(w,{className:"w-full mx-0",label:"Source",disabled:l.length<2,size:N.sm,children:({disabled:x,className:M})=>e.jsx(w.Selector,{className:h(M,"w-full"),list:l,value:o,disabled:x,onChange:c})}),e.jsx(w,{className:"w-full mx-0",label:"Target",disabled:!0,children:({disabled:x,className:M})=>e.jsx(w.Textfield,{className:h(M,"w-full"),disabled:x,value:a.value})}),e.jsx(w,{className:"w-full mx-0",label:"Limit",size:N.sm,children:({className:x})=>e.jsx(w.Textfield,{className:h(x,"w-full"),type:"number",placeholder:"1000",value:p,onInput:M=>{M.stopPropagation(),n(M.target.valueAsNumber??J)}})}),e.jsx(w,{className:"w-full mx-0",label:"ON",size:N.sm,children:({className:x})=>e.jsx(w.Textfield,{className:h(x,"w-full"),placeholder:"s.id = t.id",value:f,onInput:M=>{M.stopPropagation(),v(M.target.value)}})}),e.jsx(w,{className:"w-full mx-0",label:"WHERE",size:N.sm,children:({className:x})=>e.jsx(w.Textfield,{className:h(x,"w-full"),placeholder:"id > 10",value:P,onInput:M=>{M.stopPropagation(),g(M.target.value)}})})]})})}),e.jsx(V,{}),e.jsx(ee,{children:e.jsx("div",{className:"flex w-full justify-end items-center px-2",children:F?e.jsxs("div",{className:"flex items-center",children:[e.jsx(Z,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Getting Diff..."}),e.jsx(R,{size:N.sm,variant:_.Danger,onClick:x=>{x.stopPropagation(),b()},children:"Cancel"})]}):e.jsx(R,{className:"ml-2",size:N.sm,variant:_.Alternative,disabled:C(T)||F,onClick:x=>{x.stopPropagation(),r()},children:"Get Diff"})})})]})}function ks(){const s=j(b=>b.setPreviewDiff),[t,l]=m.useState(""),[a,d]=m.useState(""),[i,o]=m.useState(J),[c,p]=m.useState(""),[n,f]=m.useState(""),{refetch:v,isFetching:P,cancel:g}=Ee({source:t,target:a,limit:i,on:c,where:n});m.useEffect(()=>()=>{g()},[]);function y(){s(void 0),v().then(({data:b})=>{s(b)})}const F=[t,a,i,c].every(Boolean);return e.jsxs(e.Fragment,{children:[e.jsx(K,{children:e.jsx("form",{className:"w-full",children:e.jsxs("fieldset",{className:"px-2 w-full text-neutral-500",children:[e.jsx(w,{className:"w-full mx-0",label:"Source",size:N.sm,children:({className:b})=>e.jsx(w.Textfield,{className:h(b,"w-full"),placeholder:"exp.tst_model__dev",value:t,onInput:r=>{r.stopPropagation(),l(r.target.value)}})}),e.jsx(w,{className:"w-full mx-0",label:"Target",size:N.sm,children:({className:b})=>e.jsx(w.Textfield,{className:h(b,"w-full"),placeholder:"exp.tst_snapshot__1353336088",value:a,onInput:r=>{r.stopPropagation(),d(r.target.value)}})}),e.jsx(w,{className:"w-full mx-0",label:"Limit",size:N.sm,children:({className:b})=>e.jsx(w.Textfield,{className:h(b,"w-full"),type:"number",placeholder:"1000",value:i,onInput:r=>{r.stopPropagation(),o(r.target.valueAsNumber??J)}})}),e.jsx(w,{className:"w-full mx-0",label:"ON",size:N.sm,children:({className:b})=>e.jsx(w.Textfield,{className:h(b,"w-full"),placeholder:"s.id = t.id",value:c,onInput:r=>{r.stopPropagation(),p(r.target.value)}})}),e.jsx(w,{className:"w-full mx-0",label:"WHERE",size:N.sm,children:({className:b})=>e.jsx(w.Textfield,{className:h(b,"w-full"),placeholder:"id > 10",value:n,onInput:r=>{r.stopPropagation(),f(r.target.value)}})})]})})}),e.jsx(V,{}),e.jsx(ee,{children:P?e.jsxs("div",{className:"flex items-center",children:[e.jsx(Z,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Getting Diff..."}),e.jsx(R,{size:N.sm,variant:_.Danger,onClick:b=>{b.stopPropagation(),g()},children:"Cancel"})]}):e.jsx(R,{className:"ml-2",size:N.sm,variant:_.Alternative,disabled:C(F)||P,onClick:b=>{b.stopPropagation(),y()},children:"Get Diff"})})]})}const U="s__",Y="t__",me="NULL";function Ds({source_schema:s,target_schema:t},l,a){const d=Array.from(new Set(a.flat())),i=Object.keys(s),o=Object.keys(t),p=Array.from(new Set(i.concat(o))).filter(v=>i.includes(v)&&o.includes(v)),n=i.filter(v=>!o.includes(v)),f=o.filter(v=>!i.includes(v));return{all:Array.from(new Set([d,l.modifiedColumns&&p,l.addedColumns&&f,l.removedColumns&&n].filter(Boolean).flat())),added:f.length,deleted:n.length,modified:p.length-d.length}}function Ms(s,t,l){const a=Object.values(s.row_diff.sample)[0]??{},d=[],i=[],o=[];return Object.keys(a).forEach(c=>{W(s,c,l)?i.push(c):H(s,c,l)?d.push(c):o.push(c)}),{all:[t.modifiedRows&&o,t.addedRows&&i,t.removedRows&&d].filter(Boolean).flat(),added:i.length,deleted:d.length,modified:o.length}}function ce(s,t,l){const a=Q(s,U,t,l),d=Q(s,Y,t,l);return a!==d}function H(s,t,l){return l.every(([a,d])=>{const i=Q(s,U,a,t),o=Q(s,Y,d,t);return E(i)&&A(o)})}function W(s,t,l){return l.every(([a,d])=>{const i=Q(s,U,a,t),o=Q(s,Y,d,t);return A(i)&&E(o)})}function re(s,t,l,a){return l in s.schema_diff.added||l in s.schema_diff.removed?!1:t.some(d=>C(W(s,d,a))&&C(H(s,d,a))&&ce(s,l,d))}function Q(s,t,l,a){var d;return(d=s.row_diff.sample[`${t}${l}`])==null?void 0:d[a]}function _s(s,t,l){return Q(s,U,t,l)??me}function Ls(s,t,l){return Q(s,Y,t,l)??me}function Rs({diff:s}){const[t,l]=m.useState({modifiedRows:!0,addedRows:!0,removedRows:!0,modifiedColumns:!0,addedColumns:!0,removedColumns:!0}),a=Ds(s.schema_diff,t,s.on),d=Ms(s,t,s.on),i=t.addedRows&&!t.removedRows&&!t.modifiedRows,o=!t.addedRows&&t.removedRows&&!t.modifiedRows,c=Array.from(new Set(s.on.flat())),p=Object.values(s.row_diff.sample).some(n=>Object.keys(n).length>0);return e.jsxs("div",{className:"px-2 h-full flex flex-col rounded-lg",children:[p&&e.jsxs(e.Fragment,{children:[e.jsx(zs,{diff:s,rows:d,columns:a}),e.jsx("div",{className:"mt-2 mb-1 flex rounded-lg items-center",children:e.jsx("div",{className:"w-full flex justify-end items-center",children:e.jsx(Ye,{options:Object.keys(t).reduce((n,f)=>(n[f]=v=>l(P=>({...P,[f]:v})),n),{}),value:Object.keys(t).map(n=>C(t[n])?void 0:n).filter(Boolean)})})})]}),e.jsx("div",{className:"overflow-auto h-full hover:scrollbar scrollbar--horizontal scrollbar--vertical",children:e.jsxs("table",{cellPadding:0,cellSpacing:0,className:"w-full text-xs text-neutral-600 dark:text-neutral-200 font-normal border-separate",children:[e.jsx("thead",{className:"sticky bg-theme top-0 z-10",children:e.jsx("tr",{children:a.all.map(n=>e.jsx("th",{colSpan:re(s,d.all,n,s.on)?2:1,className:h("text-left whitespace-nowrap py-1 px-2 font-bold",n in s.schema_diff.added?"border-t-2 border-l-2 border-r-2 border-success-500":n in s.schema_diff.removed?"border-t-2 border-l-2 border-r-2 border-danger-500":c.includes(n)?"border-brand-500 border-l-2 border-t-2 border-r-2":"border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",c.includes(n)?"bg-brand-10":"bg-neutral-5"),children:e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"mr-2",children:[e.jsx("span",{children:n})," ",e.jsxs("small",{className:"text-neutral-500 font-medium",children:["(",s.schema_diff.source_schema[n]??s.schema_diff.target_schema[n],")"]})]}),C(c.includes(n))&&e.jsx("div",{className:"ml-2",children:e.jsxs("small",{className:"inline-block bg-neutral-10 px-2 py-0.5 rounded-full",children:[Math.round(d.all.filter(f=>ce(s,n,f)).length/d.all.length*100),"%"]})})]})},n))})}),e.jsx("tbody",{children:oe(d.all)?d.all.map(n=>e.jsx("tr",{children:a.all.map(f=>re(s,d.all,f,s.on)?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:h("p-1 border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",W(s,n,s.on)&&"bg-success-10 text-success-500",H(s,n,s.on)&&"bg-danger-5 text-danger-500"),children:e.jsx("div",{className:h("px-2 py-1 whitespace-nowrap font-bold rounded-md ",W(s,n,s.on)&&"bg-success-10 text-success-500",H(s,n,s.on)&&"bg-danger-5 text-danger-500"),children:_s(s,f,n)})},`${n}-${f}-source`),e.jsx("td",{className:h("p-1 border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",W(s,n,s.on)&&"bg-success-10 text-success-500",H(s,n,s.on)&&"bg-danger-5 text-danger-500"),children:e.jsx("div",{className:h("px-2 py-1 whitespace-nowrap font-bold rounded-md",ce(s,f,n)&&"bg-primary-10 text-primary-500",W(s,n,s.on)&&"!bg-success-10 !text-success-500",H(s,n,s.on)&&"!bg-danger-5 !text-danger-500"),children:Ls(s,f,n)})},`${n}-${f}-target`)]}):e.jsx("td",{className:h("p-1",f in s.schema_diff.added?"bg-success-10 border-l-2 border-r-2 border-success-500 text-success-500 font-bold":f in s.schema_diff.removed?"bg-danger-5 border-l-2 border-r-2 border-danger-500 !text-danger-500 font-bold":c.includes(f)?"border-brand-500 border-l-2 border-r-2":"border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",H(s,n,s.on)&&"!bg-danger-5 text-danger-500 font-bold",W(s,n,s.on)&&"bg-success-10 text-success-500 font-bold"),children:e.jsx("div",{className:h("px-2 py-1 whitespace-nowrap rounded-md",(f in s.schema_diff.added||W(s,n,s.on))&&"bg-success-10 text-success-500 font-bold",(f in s.schema_diff.removed||H(s,n,s.on))&&"!bg-danger-5 !text-danger-500 font-bold"),children:Q(s,U,f,n)??Q(s,Y,f,n)??me})},`${n}-${f}`))},n)):e.jsx(Xe,{columns:a.all.length>0?a.all.length:void 0})}),oe(d.all)&&e.jsx("tfoot",{className:"sticky bg-theme bottom-0",children:e.jsx("tr",{children:a.all.map(n=>re(s,d.all,n,s.on)?e.jsxs(e.Fragment,{children:[e.jsx("th",{className:h("text-left whitespace-nowrap px-2 py-1 border-r border-t border-neutral-100 dark:border-neutral-700 last:border-r-0",c.includes(n)?"bg-brand-10":"bg-neutral-10"),children:"Source"},`${n}-source`),e.jsx("th",{className:h("text-left whitespace-nowrap px-2 py-1 border-r border-t border-neutral-100 dark:border-neutral-700 last:border-r-0",c.includes(n)?"bg-brand-10":"bg-primary-10"),children:"Target"},`${n}-target`)]}):e.jsxs("th",{className:h("text-left whitespace-nowrap px-2 py-1 font-bold",n in s.schema_diff.added?"border-b-2 border-l-2 border-r-2 border-success-500":n in s.schema_diff.removed?"border-b-2 border-l-2 border-r-2 border-danger-500":c.includes(n)?"border-brand-500 border-l-2 border-b-2 border-r-2":"border-r border-t border-neutral-100 dark:border-neutral-700 last:border-r-0",c.includes(n)?"bg-brand-10":"bg-neutral-10"),children:[(n in s.schema_diff.removed||o)&&e.jsx("span",{children:"Source"}),(n in s.schema_diff.added||i)&&e.jsx("span",{children:"Target"})]},n))})})]})}),e.jsxs("div",{className:"flex justify-between items-center px-2 mt-2",children:[e.jsx(Je,{count:d.all.length}),e.jsx(Fs,{})]})]})}function Fs(){const s=[["Grain","bg-brand-500"],["Changed","bg-primary-500"],["Added","bg-success-500"],["Deleted","bg-danger-500"]];return e.jsx("div",{className:"flex text-xs",children:s.map(([t="",l])=>e.jsx(Is,{text:t,className:l},t))})}function Is({text:s,className:t}){return e.jsxs("div",{className:"flex ml-2 items-center",children:[e.jsx("span",{className:h("inline-block w-3 h-3 mr-2 rounded-full",t)}),e.jsx("small",{className:"text-neutral-600 dark:text-neutral-400",children:s})]})}function zs({diff:s,rows:t,columns:l}){return e.jsx(ne,{defaultOpen:!1,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(ne.Button,{className:"flex items-center w-full justify-between rounded-lg text-left text-sm px-4 pt-3 pb-2 bg-neutral-10 hover:bg-theme-darker dark:hover:bg-theme-lighter text-neutral-600 dark:text-neutral-400",children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1",children:"Stats"}),a?e.jsx(ls,{className:"h-6 w-6 text-primary-500"}):e.jsx(ns,{className:"h-6 w-6 text-primary-500"})]}),e.jsx(ne.Panel,{className:"px-4 pb-2 text-sm text-neutral-500",children:e.jsxs("div",{className:"p-2 grid grid-cols-3 gap-4 mb-3",children:[e.jsx(ae,{text:"Row Count Change",children:e.jsxs("p",{className:"text-6xl font-light text-primary-500 mt-3",children:[Math.round(Math.abs(s.row_diff.count_pct_change)),e.jsx("small",{className:"text-sm",children:"%"})]})}),e.jsxs(ae,{text:"Column Count Change",count:t.all.length,children:[e.jsx("p",{className:"text-center text-6xl font-light text-primary-500 mt-3",children:t.modified}),e.jsx("p",{className:"text-center text-6xl font-light text-success-500 mt-3",children:t.added}),e.jsx("p",{className:"text-center text-6xl font-light text-danger-500 mt-3",children:t.deleted})]}),e.jsxs(ae,{text:"Column Changes",count:l.all.length,children:[e.jsx("p",{className:"text-center text-6xl font-light text-primary-500 mt-3",children:l.modified}),e.jsx("p",{className:"text-center text-6xl font-light text-success-500 mt-3",children:l.added}),e.jsx("p",{className:"text-center text-6xl font-light text-danger-500 mt-3",children:l.deleted})]})]})})]})})}function ae({text:s,children:t,className:l,count:a}){return e.jsxs("div",{className:h("rounded-xl overflow-hidden px-3 py-6 bg-primary-10",l),children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h3",{className:"text-neutral-500 dark:text-neutral-300 text-sm font-bold",children:s}),E(a)&&e.jsx("div",{children:e.jsx("small",{className:"inline-block px-2 py-0.5 bg-neutral-10 rounded-full",children:a})})]}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:t})]})}const As=m.lazy(async()=>await Qe(()=>import("./ModelLineage-4446a7e1.js"),[])),B={Query:"Query",Table:"Data Preview",Console:"Logs",Lineage:"Lineage",Diff:"Diff",Errors:"Errors"};function Qs({tab:s,className:t}){const{errors:l,removeError:a}=Te(),d=Oe(),i=S(x=>x.models),o=S(x=>x.isModel),c=j(x=>x.direction),p=j(x=>x.previewQuery),n=j(x=>x.previewTable),f=j(x=>x.previewDiff),v=j(x=>x.setDirection),[P,g]=m.useState(-1),y=Se(s.file.path,x=>{d(`${Be.DataCatalogModels}/${x.name}`)}),F=i.get(s.file.path),b=C(s.file.isEmpty)&&E(F)&&o(s.file.path),r=l.size>0,T=m.useMemo(()=>[E(n)&&B.Table,E(p)&&s.file.isRemote&&B.Query,b&&B.Lineage,E(f)&&B.Diff,r&&B.Errors].filter(Boolean),[s.id,n,p,f,b,l,r]);return m.useEffect(()=>{E(n)?g(T.indexOf(B.Table)):g(0)},[n]),m.useEffect(()=>{E(f)?g(T.indexOf(B.Diff)):g(0)},[f]),m.useEffect(()=>{E(b)?g(T.indexOf(B.Lineage)):g(0)},[b]),m.useEffect(()=>{g(r?T.indexOf(B.Errors):0)},[r]),m.useEffect(()=>{for(const x of l)He([z.Fetchdf,z.EvaluateModel,z.RenderQuery,z.ColumnLineage,z.ModelLineage,z.TableDiff,z.Table,z.SaveFile],x.key)&&a(x)},[n,f,p,b]),e.jsx("div",{className:h("w-full h-full flex flex-col text-prose overflow-auto hover:scrollbar scrollbar--vertical",t),children:We(T)?e.jsx("div",{className:"flex justify-center items-center w-full h-full",children:e.jsx("h3",{className:"text-md",children:"No Data To Preview"})}):e.jsxs(k.Group,{onChange:g,selectedIndex:P,children:[e.jsx(de,{list:T,children:e.jsx("div",{className:"ml-2",children:e.jsx(R,{className:"!m-0 !py-0.5 px-[0.25rem] border-none",variant:_.Alternative,size:N.sm,onClick:()=>{v(c==="horizontal"?"vertical":"horizontal")},children:e.jsx(fs,{"aria-label":c==="horizontal"?"Use vertical layout":"Use horizontal layout",className:"text-primary-500 w-5"})})})},T.join("-")),e.jsxs(k.Panels,{className:"h-full w-full overflow-hidden",children:[E(n)&&e.jsx(k.Panel,{unmount:!1,className:h("w-full h-full pt-4 relative px-2","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(Ze,{data:n})}),E(p)&&s.file.isRemote&&e.jsx(k.Panel,{unmount:!1,className:"w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 p-2",children:e.jsx("div",{className:"w-full h-full p-2 bg-primary-10 rounded-lg overflow-auto hover:scrollbar scrollbar--horizontal scrollbar--vertical",children:e.jsx(ie,{type:$.SQL,content:p??"",extensions:y,className:"text-xs"})})}),b&&e.jsx(k.Panel,{unmount:!1,className:h("w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(m.Suspense,{fallback:e.jsx($e,{children:"Loading Model page..."}),children:e.jsx(As,{model:F})})}),E(f==null?void 0:f.row_diff)&&e.jsx(k.Panel,{unmount:!1,className:h("w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 py-2"),children:e.jsx(Rs,{diff:f},s.id)}),r&&e.jsx(k.Panel,{unmount:!1,className:"w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 py-2",children:e.jsx("ul",{className:"w-full h-full p-2 overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",children:Array.from(l).reverse().map(x=>e.jsx("li",{className:"bg-danger-10 mb-4 last:m-0 p-2 rounded-md",children:e.jsx(rs,{scope:x.key,error:x})},x.id))})})]})]},s.id)})}const X=32,Os=2;function fe(){const s=j(t=>t.tab);return e.jsxs("div",{className:"w-full h-full flex flex-col overflow-hidden",children:[e.jsx(bs,{}),e.jsx(V,{}),A(s)?e.jsx(xe,{}):e.jsx(Pe,{tab:s})]})}function xe(){return e.jsx("div",{className:"flex justify-center items-center w-full h-full",children:e.jsx("div",{className:"p-4 text-center text-theme-darker dark:text-theme-lighter",children:e.jsx("h2",{className:"text-3xl",children:"Select File or Add New SQL Tab"})})})}function Pe({tab:s}){const{errors:t,addError:l,removeError:a}=Te(),d=S(u=>u.environment),i=S(u=>u.models),o=S(u=>u.isModel),c=G(u=>u.files),p=G(u=>u.selectedFile),n=G(u=>u.setSelectedFile),f=j(u=>u.direction),v=j(u=>u.engine),P=j(u=>u.previewTable),g=j(u=>u.previewDiff),y=j(u=>u.refreshTab),F=j(u=>u.updateStoredTabsIds),b=j(u=>u.setPreviewQuery),r=j(u=>u.setPreviewTable),T=j(u=>u.setPreviewDiff),x=j(u=>u.setDialects),{setManuallySelectedColumn:M}=es(),ke=m.useCallback(function(u){n(c.get(u.path))},[c]),De=m.useCallback(function(u,D){M([u,D])},[]),se=ss(),he=Se(s.file.path,ke,De),[pe,te]=m.useState(!1),Me=m.useMemo(()=>[...se,{key:"Mod-Enter",win:"Ctrl-Enter",preventDefault:!0,stopPropagation:!0,run(u){const D=u.state.doc.toString();r(void 0),b(D);for(const O of t)O.key===z.Fetchdf&&a(O);return Ge({sql:D}).then(O=>{r(ue(O))}).catch(O=>{l(z.Fetchdf,{...O,errorKey:z.Fetchdf,trigger:"Editor -> customSQLKeymaps",message:O.message,timestamp:Date.now(),origin:"useQueryTimeout"})}),!0}}],[se,t]);m.useEffect(()=>{te(!1),A(p)&&n(s==null?void 0:s.file)},[s.id]),m.useEffect(()=>(v.addEventListener("message",ve),()=>{v.removeEventListener("message",ve)}),[s.id,s.dialect]),m.useEffect(()=>{b(void 0),r(void 0),T(void 0),F()},[s.id,s.file.fingerprint]),m.useEffect(()=>{T(void 0)},[d]);function _e(){const u=i.get(s.file.path),D=C(s.file.isEmpty)&&E(u)&&o(s.file.path);return t.size>0||[P,g].some(Boolean)||D?[70,30]:[100,0]}function Le(){const u=i.get(s==null?void 0:s.file.path);return pe&&(E(u)&&o(s.file.path)||s.file.isLocal)&&C(q(s.file.content))?[70,30]:[100,0]}function ge(u){s.file.content=u,y(s)}function ve(u){if(u.data.topic==="dialects"){const D=i.get(s.file.path);s.dialect=(D==null?void 0:D.dialect)??s.dialect??"",x(u.data.payload),y(s)}if(u.data.topic==="format"){if(q(u.data.payload))return;s.file.content=u.data.payload,y(s)}}return e.jsxs(be,{className:h("w-full h-full overflow-hidden",f==="vertical"?"flex flex-col":"flex"),sizes:_e(),direction:f,minSize:[X,0],snapOffset:0,children:[e.jsxs("div",{className:h("flex flex-col",f==="vertical"?"w-full ":"h-full"),children:[e.jsxs(be,{className:"flex h-full overflow-hidden",sizes:Le(),minSize:X,snapOffset:X,handleDrag:(u,D)=>{const Re=D.parent.getBoundingClientRect().width*(u[1]??0)/100;te(Re>=X+Os)},children:[e.jsxs("div",{className:"flex flex-col h-full",children:[s.file.isLocal&&e.jsx(ie,{type:$.SQL,dialect:s.dialect,keymaps:Me,content:s.file.content,extensions:he,onChange:ge}),s.file.isRemote&&e.jsx(ts,{keymaps:se,path:s.file.path,children:({file:u,keymaps:D})=>e.jsx(ie,{type:u.extension,dialect:s.dialect,extensions:he,keymaps:D,content:u.content,onChange:ge})})]}),e.jsx("div",{className:"flex flex-col h-full",children:e.jsx(Ns,{tab:s,toggle:()=>te(u=>!u),isOpen:pe})})]},s.id),e.jsx(V,{}),e.jsx(vs,{tab:s},s.file.fingerprint)]}),e.jsx(Qs,{tab:s,className:h(f==="vertical"?"flex flex-col":"flex")})]},f)}fe.Empty=xe;fe.Loading=xe;fe.Main=Pe;export{fe as default};
