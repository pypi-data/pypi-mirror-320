(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1929],{39929:function(e,t,s){Promise.resolve().then(s.bind(s,74723))},74723:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return w}});var a=s(57437),o=s(63136),n=s.n(o),i=s(2265),r=s(53789),l=s(99376),c=s(14308),d=s(59199);s(2446);var u=s(7436),h=s(5477),m=s(56937),g=s(55287),f=s(85872),p=s(34124),x=s(6512),_=s(37104);function y(e){let t=(0,l.useSearchParams)().get("conversationId"),[s,o]=(0,i.useState)(""),[c,d]=(0,i.useState)([]),[u,m]=(0,i.useState)(!1),[g,f]=(0,i.useState)(null),[p,x]=(0,i.useState)(!1),_=(0,i.useRef)(null),y=e.setQueryToProcess,w=e.onConversationIdChange,S=e.isMobileWidth?"w-full":"w-4/6";if((0,i.useEffect)(()=>{if(c.length>0){let t=c.map(e=>encodeURIComponent(e));e.setImages(t)}},[c,e.setImages]),(0,i.useEffect)(()=>{let t=localStorage.getItem("images");if(t){let s=JSON.parse(t);d(s);let a=s.map(e=>encodeURIComponent(e));e.setImages(a),localStorage.removeItem("images")}let s=localStorage.getItem("message");s&&(m(!0),y(s),s.trim().startsWith("/research")&&x(!0));let a=localStorage.getItem("uploadedFiles");if(a){let t=a?JSON.parse(a):[],s=[];for(let e of t)s.push({name:e.name,file_type:e.file_type,content:e.content,size:e.size});localStorage.removeItem("uploadedFiles"),e.setUploadedFiles(s)}},[y,e.setImages,t]),(0,i.useEffect)(()=>{s&&(m(!0),y(s))},[s,y]),(0,i.useEffect)(()=>{t&&(null==w||w(t))},[t,w]),(0,i.useEffect)(()=>{e.streamedMessages&&e.streamedMessages.length>0&&e.streamedMessages[e.streamedMessages.length-1].completed?(m(!1),d([]),e.setUploadedFiles(void 0)):o("")},[e.streamedMessages]),!t){window.location.href="/";return}return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:n().chatBodyFull,children:(0,a.jsx)(r.Z,{conversationId:t,setTitle:e.setTitle,setAgent:f,pendingMessage:u?s:"",incomingMessages:e.streamedMessages,setIncomingMessages:e.setStreamedMessages,customClassName:S})}),(0,a.jsx)("div",{className:"".concat(n().inputBox," p-1 md:px-2 shadow-md bg-background align-middle items-center justify-center dark:bg-neutral-700 dark:border-0 dark:shadow-sm rounded-2xl md:rounded-xl h-fit ").concat(S," mr-auto ml-auto"),children:(0,a.jsx)(h.a,{agentColor:null==g?void 0:g.color,isLoggedIn:e.isLoggedIn,sendMessage:e=>o(e),sendImage:e=>d(t=>[...t,e]),sendDisabled:u,chatOptionsData:e.chatOptionsData,conversationId:t,isMobileWidth:e.isMobileWidth,setUploadedFiles:e.setUploadedFiles,ref:_,isResearchModeEnabled:p,setTriggeredAbort:e.setTriggeredAbort})})]})}function w(){let e="Khoj AI - Chat",[t,s]=(0,i.useState)(null),[o,r]=(0,i.useState)(!0),[l,h]=(0,i.useState)(e),[w,S]=(0,i.useState)(null),[I,b]=(0,i.useState)([]),[v,j]=(0,i.useState)(""),[C,B]=(0,i.useState)(!1),[E,N]=(0,i.useState)(void 0),[T,k]=(0,i.useState)([]),[M,F]=(0,i.useState)(null),[R,O]=(0,i.useState)(!1),{locationData:D,locationDataError:W,locationDataLoading:L}=(0,u.k6)()||{locationData:{timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}},{data:P,error:A,isLoading:U}=(0,m.GW)(),z=(0,u.IC)();async function K(e){if(!e.ok)throw Error(e.statusText);if(!e.body)throw Error("Response body is null");let t=e.body.getReader(),s=new TextDecoder,a="␃\uD83D\uDD1A␗",o="",n=[],i={},r={};for(;;){let e;let{done:l,value:c}=await t.read();if(l){j(""),B(!1),k([]),w&&(0,d.tQ)(w,h);break}for(o+=s.decode(c,{stream:!0});-1!==(e=o.indexOf(a));){let t=o.slice(0,e);if(o=o.slice(e+a.length),t){let e=I.find(e=>!e.completed);if(!e){console.error("No current message found");return}({context:n,onlineContext:i,codeContext:r}=(0,d.VK)(t,e,n,i,r)),b([...I])}}}}async function Q(){if(localStorage.removeItem("message"),!v||!w)return;let e={q:v,conversation_id:w,stream:!0,...D&&{city:D.city,region:D.region,country:D.country,country_code:D.countryCode,timezone:D.timezone},...T.length>0&&{images:T},...E&&{files:E}},t=await fetch("/api/chat?client=web",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:null==M?void 0:M.signal});try{await K(t)}catch(n){let e=await t.json();console.error(e);let s=I.find(e=>!e.completed);if(!s)return;let a=n.message,o=n.name;a.includes("Error in input stream")?s.rawResponse="Woops! The connection broke while I was writing my thoughts down. Maybe try again in a bit or dislike this message if the issue persists?":429===t.status?"detail"in e?s.rawResponse="".concat(e.detail):s.rawResponse="I'm a bit overwhelmed at the moment. Could you try again in a bit or dislike this message if the issue persists?":"AbortError"===o?s.rawResponse="I've stopped processing this message. If you'd like to continue, please send the message again.":s.rawResponse="Umm, not sure what just happened. I see this error message: ".concat(a,". Could you try again or dislike this message if the issue persists?"),s.completed=!0,b([...I]),j(""),B(!1)}}return(0,i.useEffect)(()=>{fetch("/api/chat/options").then(e=>e.json()).then(e=>{r(!1),e&&s(e)}).catch(e=>{console.error(e)}),(0,u.EK)()},[]),(0,i.useEffect)(()=>{R&&(null==M||M.abort(),function(){let e=I.find(e=>!e.completed);e&&(e.completed=!0,b([...I]),j(""),B(!1))}(),O(!1))}),(0,i.useEffect)(()=>{if(v){let e={rawResponse:"",trainOfThought:[],context:[],onlineContext:{},codeContext:{},completed:!1,timestamp:new Date().toISOString(),rawQuery:v||"",images:T,queryFiles:E};b(t=>[...t,e]),B(!0),F(new AbortController)}},[v]),(0,i.useEffect)(()=>{C&&!L&&Q()},[C,L]),o?(0,a.jsx)(c.Z,{}):(0,a.jsxs)(f.Hn,{children:[(0,a.jsx)(p.S,{conversationId:w||""}),(0,a.jsxs)(f.kV,{children:[(0,a.jsxs)("header",{className:"flex h-16 shrink-0 items-center gap-2 border-b px-4",children:[(0,a.jsx)(f.vP,{className:"-ml-1"}),(0,a.jsx)(x.Z,{orientation:"vertical",className:"mr-2 h-4"}),w&&(0,a.jsx)("div",{className:"".concat(n().chatTitleWrapper," text-nowrap text-ellipsis overflow-hidden max-w-screen-md grid items-top font-bold mx-2 md:mr-8 col-auto h-fit"),children:z?(0,a.jsx)("a",{className:"p-0 no-underline",href:"/",children:(0,a.jsx)(_.VO,{className:"h-auto w-16"})}):l&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h2",{className:"text-lg text-ellipsis whitespace-nowrap overflow-x-hidden mr-4",children:l}),(0,a.jsx)(g.En,{conversationId:w,setTitle:h,sizing:"md"})]})})]}),(0,a.jsxs)("div",{className:"".concat(n().main," ").concat(n().chatLayout),children:[(0,a.jsx)("title",{children:"".concat(e).concat(l&&l!==e?": ".concat(l):"")}),(0,a.jsx)("div",{className:n().chatBox,children:(0,a.jsx)("div",{className:n().chatBoxBody,children:(0,a.jsx)(i.Suspense,{fallback:(0,a.jsx)(c.Z,{}),children:(0,a.jsx)(y,{isLoggedIn:!!P,streamedMessages:I,setStreamedMessages:b,chatOptionsData:t,setTitle:h,setQueryToProcess:j,setUploadedFiles:N,isMobileWidth:z,onConversationIdChange:e=>{S(e)},setImages:k,setTriggeredAbort:O})})})})]})]})]})}},99376:function(e,t,s){"use strict";var a=s(35475);s.o(a,"useRouter")&&s.d(t,{useRouter:function(){return a.useRouter}}),s.o(a,"useSearchParams")&&s.d(t,{useSearchParams:function(){return a.useSearchParams}})},63136:function(e){e.exports={main:"chat_main__8xQu5",suggestions:"chat_suggestions__m8n2t",inputBox:"chat_inputBox__LOFws",chatBodyFull:"chat_chatBodyFull__FfKEK",chatBody:"chat_chatBody__sS1LX",chatLayout:"chat_chatLayout__pR203",chatBox:"chat_chatBox__FBct_",titleBar:"chat_titleBar__R5QlK",chatBoxBody:"chat_chatBoxBody__qT_SC",agentIndicator:"chat_agentIndicator__8V55w",chatTitleWrapper:"chat_chatTitleWrapper__6ChWq"}}},function(e){e.O(0,[8255,1491,3954,9259,8667,182,1010,6293,4124,5477,3789,2971,2117,1744],function(){return e(e.s=39929)}),_N_E=e.O()}]);