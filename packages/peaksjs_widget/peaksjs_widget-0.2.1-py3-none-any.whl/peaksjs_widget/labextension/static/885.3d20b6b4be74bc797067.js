"use strict";(self.webpackChunkpeaksjs_widget=self.webpackChunkpeaksjs_widget||[]).push([[885],{1797:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MODULE_NAME=t.MODULE_VERSION=void 0;const n=i(8330);t.MODULE_VERSION=n.version,t.MODULE_NAME=n.name},8885:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function a(e){try{r(n.next(e))}catch(e){o(e)}}function l(e){try{r(n.throw(e))}catch(e){o(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,l)}r((n=n.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PeaksJSView=t.PeaksJSModel=void 0;const o=i(1797),a=s(i(765));i(890);const l=i(7464),r=s(i(4758)),d=s(i(8506)),c=i(7093);class m{constructor(e){this._options=e}init(e){this.handleHeight=20,this._handle=new d.default.Rect({x:-4.5,y:0,width:10,height:this.handleHeight,fill:this._options.color}),this._line=new d.default.Line({stroke:this._options.color,strokeWidth:1}),e.add(this._handle),e.add(this._line),this.fitToView()}fitToView(){const e=this._options.layer.getHeight();this._handle.y(e/2-this.handleHeight/2),this._line.points([.5,0,.5,e])}timeUpdated(){}destroy(){}}function p(e){return new m(e)}class u extends l.DOMWidgetModel{defaults(){return Object.assign(Object.assign({},super.defaults()),{_model_name:u.model_name,_model_module:u.model_module,_model_module_version:u.model_module_version,_view_name:u.view_name,_view_module:u.view_module,_view_module_version:u.view_module_version})}}t.PeaksJSModel=u,u.serializers=Object.assign({zoomview:{deserialize:l.unpack_models},overview:{deserialize:l.unpack_models},play_button:{deserialize:l.unpack_models},save_button:{deserialize:l.unpack_models},audio:{deserialize:l.unpack_models}},l.DOMWidgetModel.serializers),u.model_name="PeaksJSModel",u.model_module=o.MODULE_NAME,u.model_module_version=o.MODULE_VERSION,u.view_name="PeaksJSView",u.view_module=o.MODULE_NAME,u.view_module_version=o.MODULE_VERSION;class h extends l.DOMWidgetView{render(){super.render(),this.model.on("change:zoomview",this.init_zoomview,this),this.model.on("change:overview",this.init_overview,this),this.model.on("change:play_button",this.init_play_button,this),this.model.on("change:save_button",this.init_save_button,this),this.model.on("change:audio",this.init_peaks,this),this.model.on("change:segments",this.segments_changed,this),this.model.on("change:points",this.points_changed,this),this.model.on("change:playing",this.toggle_playing,this),this.views=new l.ViewList(this.add_view,null,this);const e=this;this.listenTo(this.model,"change:segments",this.segments_changed),this.listenTo(this.model,"change:points",this.points_changed),this.displayed.then((()=>{e.init_zoomview(),e.init_overview(),e.init_play_button(),e.init_save_button(),e.init_peaks()})),this.views.update([this.model.get("zoomview"),this.model.get("overview"),this.model.get("play_button"),this.model.get("save_button"),this.model.get("audio")]).then((e=>e.map((e=>e.render()))));const t=this.model.get("element_id");(0,a.default)(this.el).attr("id",t)}add_view(e,t){return this.create_child_view(e,{parent:this}).then((e=>(e.trigger("displayed"),e))).catch((e=>e))}init_zoomview(){const e=this,t=this.model.get("element_id");this.views.views[0].then((i=>{e.zoomview=(0,a.default)(i.el).text("\n").attr("id","zoomview-"+t).attr("tabindex","0").css({width:"100%",height:"200px","white-space":"pre"}),e.model.get("as_container")&&(0,a.default)(e.el).append(e.zoomview)}))}init_overview(){const e=this,t=this.model.get("element_id");this.views.views[1].then((i=>{e.overview=(0,a.default)(i.el).text("\n").attr("id","overview-"+t).css({width:"100%",height:"15px","white-space":"pre"}),e.model.get("as_container")&&(0,a.default)(e.el).append(e.overview)}))}init_play_button(){const e=this.model,t=this;this.views.views[2].then((i=>{this.playBtn=(0,a.default)(i.el).on("click",(function(){const i=e.get("playing");e.set("playing",!i),e.save_changes(),t.touch(),t.send({playing:!i})})),t.model.get("as_container")&&(0,a.default)(this.el).append(this.playBtn)}))}init_save_button(){const e=this;this.views.views[3].then((t=>{(0,a.default)(e.el).append((0,a.default)(t.el).on("click",(function(){const t=document.createElement("a");t.href=e.audio.src,t.setAttribute("download",`${e.model.get("element_id")}.mp3`),document.body.appendChild(t),t.click()})))}))}init_peaks(){const e=this,t=this.model.get("segments"),i=this.model.get("points"),s=this.model.get("sample_rate");Promise.all(this.views.views).then((o=>{const l=o[4].el;l.preload="metadata",l.onloadedmetadata=d=>{const m=new AudioContext({sampleRate:s}),u=o[0].el,h=o[1].el;let v=e.model.get("min_samples_per_pixel");(0,a.default)(e.el).append(l),e.audio=l;const g={waveformCache:!0,zoomview:{container:u,waveformColor:"rgba(0,100,255,0.95)",playheadColor:"#000000",wheelMode:"scroll",timeLabelPrecision:4,showPlayheadTime:!0},overview:{container:h,waveformColor:"rgba(0,100,255,0.95)",playheadColor:"#000000",showAxisLabels:!1,highlightOffset:0},zoomLevels:[v,2*v,3*v,4*v,6*v,10*v],mediaElement:l,webAudio:{audioContext:m,scale:v,multiChannel:!1},keyboard:!1,nudgeIncrement:1,segments:t,points:i,createSegmentMarker:p};r.default.init(g,(function(t,i){return n(this,void 0,void 0,(function*(){if(t||null==i)return void console.error("Failed to initialize Peaks instance: "+t.message);e.peaks=i;const s=i.views.getView("zoomview");s.setZoom({seconds:Math.min(l.duration,180)}),i.on("zoomview.contextmenu",(t=>{if(t.evt.preventDefault(),t.evt.stopImmediatePropagation(),t.evt.stopPropagation(),t.evt.ctrlKey&&!t.evt.altKey&&!t.evt.shiftKey){const n={time:t.time,color:"#ff640e",editable:!0},{id:s}=i.points.add(n);e.send({newPoint:Object.assign(Object.assign({},n),{id:s})})}})),i.on("zoomview.click",(t=>{if(t.evt.altKey&&!t.evt.shiftKey&&!t.evt.ctrlKey){const n={startTime:t.time,endTime:t.time+.1,editable:!0,id:e.model.get("id_count"),color:"#ff640e",labelText:""};i.segments.add(n),e.model.set("id_count",n.id+1),e.touch(),e.send({newSegment:n})}})),i.on("segments.click",(t=>{if(t.evt.preventDefault(),t.evt.stopImmediatePropagation(),t.evt.stopPropagation(),t.evt.shiftKey)i.segments.removeById(t.segment.id),e.send({removeSegment:{startTime:t.segment.startTime,endTime:t.segment.endTime,id:t.segment.id,color:t.segment.color,labelText:t.segment.labelText}}),t.evt.preventDefault();else if(t.evt.ctrlKey&&t.evt.altKey){const i=prompt("Enter segment label","0");t.segment.update({labelText:i,startTime:t.segment.startTime,endTime:t.segment.endTime}),e.send({editSegment:{startTime:t.segment.startTime,endTime:t.segment.endTime,id:t.segment.id,color:t.segment.color,labelText:i,editable:!0}})}else e.send({clickSegment:{startTime:t.segment.startTime,endTime:t.segment.endTime,id:t.segment.id,color:t.segment.color,labelText:t.segment.labelText,editable:t.segment.editable}})})),i.on("segments.dragend",(t=>{e.send({editSegment:{startTime:t.segment.startTime,endTime:t.segment.endTime,id:t.segment.id,color:t.segment.color,labelText:t.segment.labelText,editable:!0}})})),i.on("points.dragend",(t=>{e.send({editPoint:{time:t.point.time,id:t.point.id,color:t.point.color,labelText:t.point.labelText,editable:!0}})})),i.on("points.click",(t=>{if(t.evt.preventDefault(),t.evt.stopImmediatePropagation(),t.evt.stopPropagation(),t.evt.shiftKey)e.send({removePoint:{time:t.point.time,id:t.point.id,color:t.point.color,labelText:t.point.labelText}}),t.evt.preventDefault();else if(t.evt.ctrlKey&&t.evt.altKey){const i=prompt("Enter point label","0");t.point.update({labelText:i,time:t.point.time}),e.send({editPoint:{time:t.point.time,id:t.point.id,color:t.point.color,labelText:i,editable:!0}})}})),i.on("player.seeked",(e=>{})),u.addEventListener("keydown",(t=>{if("Space"===t.code)e.playBtn.trigger("click"),t.preventDefault();else if(t.code.includes("Arrow")){const e=i.player.getCurrentTime(),n=i.views.getView("zoomview"),s=n.getEndTime()-n.getStartTime();let o=.002;t.shiftKey&&(o=.02),"ArrowRight"===t.code?i.player.seek(e+s*o):"ArrowLeft"===t.code&&i.player.seek(e-s*o)}})),u.addEventListener("wheel",(t=>{const n=i.views.getView("zoomview");n&&t.ctrlKey&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),(0,c.zoom)(i,n,t,v,5),e.send({updateZoomView:{startTime:n.getStartTime(),endTime:n.getEndTime()}}))})),u.addEventListener("dblclick",(t=>{t.shiftKey?i.views.getView("zoomview").setZoom({seconds:Math.min(i.player.getDuration(),180)}):t.altKey||e.playBtn.trigger("click")})),i.once("peaks.ready",(()=>n(this,void 0,void 0,(function*(){yield(0,c.cacheResampledData)(s,50,5,v)}))))}))}))}}))}segments_changed(){let e=this.model.get("segments");this.peaks.segments.removeAll(),this.peaks.segments.add(e)}points_changed(){let e=this.model.get("points");this.peaks.points.removeAll(),this.peaks.points.add(e)}toggle_playing(){this.model.get("playing")?(this.peaks.player.play(),this.playBtn.children("i").removeClass("fa-play").addClass("fa-pause")):(this.peaks.player.pause(),this.playBtn.children("i").removeClass("fa-pause").addClass("fa-play"))}}t.PeaksJSView=h},7093:function(e,t){var i=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function a(e){try{r(n.next(e))}catch(e){o(e)}}function l(e){try{r(n.throw(e))}catch(e){o(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,l)}r((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.zoom=function(e,t,i,n,s){const o=t._data,a=o.length;let l=i.wheelDelta>0?.95:1.05;const r=e.player.getCurrentTime();let d,c=t._playheadLayer.getPlayheadOffset();c>=0&&c<t._width?d=r:(c=Math.floor(t._width/2),d=t.pixelOffsetToTime(c));const m=Math.max(Math.min(a*l,o.duration*o.sample_rate/n),o.duration*t._width/Math.min(180,o.duration));let p=Math.floor(o.duration*o.sample_rate/m);l>1?p=Math.floor(p/s)*s:(p=Math.ceil(p/s)*s,p===t._scale&&(p+=s)),t._resampleData({scale:p}),t._updateWaveform(t.timeToPixels(d)-c),t._playheadLayer.zoomLevelChanged(t._framOffset),t._playheadLayer.updatePlayheadTime(r)},t.cacheResampledData=function(e,t,n,s){return i(this,void 0,void 0,(function*(){yield Promise.all([...Array(t+1).keys()].map((t=>setTimeout((()=>function(t){return i(this,void 0,void 0,(function*(){if((t*=n)>s){let i;i=e._waveformData.has(t-n)?e._waveformData.get(t-n):e._originalWaveformData,e._waveformData.set(t,i.resample({scale:t})),e._waveformScales.push(t)}}))}(t)),0)))).then((t=>e._waveformScales.sort((function(e,t){return e-t}))))}))}},6780:(e,t,i)=>{i.d(t,{A:()=>l});var n=i(6551),s=i.n(n),o=i(1992),a=i.n(o)()(s());a.push([e.id,"\n",""]);const l=a},1992:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var i="",n=void 0!==t[5];return t[4]&&(i+="@supports (".concat(t[4],") {")),t[2]&&(i+="@media ".concat(t[2]," {")),n&&(i+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),i+=e(t),n&&(i+="}"),t[2]&&(i+="}"),t[4]&&(i+="}"),i})).join("")},t.i=function(e,i,n,s,o){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(n)for(var l=0;l<this.length;l++){var r=this[l][0];null!=r&&(a[r]=!0)}for(var d=0;d<e.length;d++){var c=[].concat(e[d]);n&&a[c[0]]||(void 0!==o&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=o),i&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=i):c[2]=i),s&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=s):c[4]="".concat(s)),t.push(c))}},t}},6551:e=>{e.exports=function(e){return e[1]}},890:(e,t,i)=>{i.r(t),i.d(t,{default:()=>f});var n=i(8318),s=i.n(n),o=i(5879),a=i.n(o),l=i(237),r=i.n(l),d=i(4862),c=i.n(d),m=i(1050),p=i.n(m),u=i(8495),h=i.n(u),v=i(6780),g={};g.styleTagTransform=h(),g.setAttributes=c(),g.insert=r().bind(null,"head"),g.domAPI=a(),g.insertStyleElement=p(),s()(v.A,g);const f=v.A&&v.A.locals?v.A.locals:void 0},8318:e=>{var t=[];function i(e){for(var i=-1,n=0;n<t.length;n++)if(t[n].identifier===e){i=n;break}return i}function n(e,n){for(var o={},a=[],l=0;l<e.length;l++){var r=e[l],d=n.base?r[0]+n.base:r[0],c=o[d]||0,m="".concat(d," ").concat(c);o[d]=c+1;var p=i(m),u={css:r[1],media:r[2],sourceMap:r[3],supports:r[4],layer:r[5]};if(-1!==p)t[p].references++,t[p].updater(u);else{var h=s(u,n);n.byIndex=l,t.splice(l,0,{identifier:m,updater:h,references:1})}a.push(m)}return a}function s(e,t){var i=t.domAPI(t);return i.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;i.update(e=t)}else i.remove()}}e.exports=function(e,s){var o=n(e=e||[],s=s||{});return function(e){e=e||[];for(var a=0;a<o.length;a++){var l=i(o[a]);t[l].references--}for(var r=n(e,s),d=0;d<o.length;d++){var c=i(o[d]);0===t[c].references&&(t[c].updater(),t.splice(c,1))}o=r}}},237:e=>{var t={};e.exports=function(e,i){var n=function(e){if(void 0===t[e]){var i=document.querySelector(e);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(e){i=null}t[e]=i}return t[e]}(e);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(i)}},1050:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},4862:(e,t,i)=>{e.exports=function(e){var t=i.nc;t&&e.setAttribute("nonce",t)}},5879:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(i){!function(e,t,i){var n="";i.supports&&(n+="@supports (".concat(i.supports,") {")),i.media&&(n+="@media ".concat(i.media," {"));var s=void 0!==i.layer;s&&(n+="@layer".concat(i.layer.length>0?" ".concat(i.layer):""," {")),n+=i.css,s&&(n+="}"),i.media&&(n+="}"),i.supports&&(n+="}");var o=i.sourceMap;o&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),t.styleTagTransform(n,e,t.options)}(t,e,i)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},8495:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},8330:e=>{e.exports=JSON.parse('{"name":"peaksjs-widget","version":"0.2.1","description":"ipywidget to interact with audio waveforms through peaks.js","keywords":["jupyter","jupyterlab","jupyterlab-extension","widgets"],"files":["lib/**/*.js","dist/*.js","css/*.css"],"homepage":"https://github.com/ktonal/peaksjs-widget","bugs":{"url":"https://github.com/ktonal/peaksjs-widget/issues"},"license":"BSD-3-Clause","author":{"name":"AntoineDaurat","email":"ktonalberlin@gmail.com"},"main":"lib/index.js","types":"./lib/index.d.ts","repository":{"type":"git","url":"https://github.com/ktonal/peaksjs-widget"},"scripts":{"build":"yarn run build:lib && yarn run build:labextension:dev","build:prod":"yarn run build:lib && yarn run build:labextension","build:labextension":"jupyter labextension build .","build:labextension:dev":"jupyter labextension build --development True .","build:lib":"tsc","clean":"yarn run clean:lib && yarn run clean:labextension","clean:lib":"rimraf lib","clean:labextension":"rimraf peaksjs_widget/labextension","lint":"eslint . --ext .ts,.tsx --fix","lint:check":"eslint . --ext .ts,.tsx","prepack":"yarn run build:lib","test":"jest","watch":"npm-run-all -p watch:*","watch:lib":"tsc -w"},"dependencies":{"@jupyter-widgets/base":"^6","@jupyter-widgets/controls":"^5","konva":"^9.3.18","peaks.js":"^3.4.2","underscore":"^1.13.7","waveform-data":"^4","jquery":"^3.7.1"},"devDependencies":{"@babel/core":"^7.26.0","@babel/preset-env":"^7.26.0","@jupyter-widgets/base-manager":"^1.0.11","@jupyterlab/builder":"^4.3.4","@lumino/application":"^2.4.1","@lumino/widgets":"^2.5.0","@types/jest":"^29.5.14","@types/webpack-env":"^1.18.5","@typescript-eslint/eslint-plugin":"^8.19.1","@typescript-eslint/parser":"^8.19.1","acorn":"^8.14.0","css-loader":"^7.1.2","eslint":"^9.17.0","eslint-config-prettier":"^9.1.0","eslint-plugin-prettier":"^5.2.1","fs-extra":"^11.2.0","identity-obj-proxy":"^3.0.0","jest":"^29.7.0","mkdirp":"^3.0.1","npm-run-all":"^4.1.5","prettier":"^3.4.2","rimraf":"^6.0.1","source-map-loader":"^5.0.0","style-loader":"^4.0.0","ts-jest":"^29.2.5","ts-loader":"^9.5.1","typescript":"~5.7.3","webpack":"^5.97.1","webpack-cli":"^6.0.1"},"jupyterlab":{"extension":"lib/plugin","outputDir":"peaksjs_widget/labextension/","sharedPackages":{"@jupyter-widgets/base":{"bundled":false,"singleton":true}}}}')}}]);