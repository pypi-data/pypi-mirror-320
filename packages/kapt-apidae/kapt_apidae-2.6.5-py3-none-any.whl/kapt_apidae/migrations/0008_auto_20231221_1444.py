# Generated by Django 3.2.22 on 2023-12-21 13:44

from django.db import migrations


def forwards_func(apps, schema_editor):
    TouristicObject = apps.get_model("kapt_apidae", "TouristicObject")
    Activity = apps.get_model("kapt_catalog", "Activity")

    activities = Activity.objects.all().select_related("structure__reference")
    nb_activities = activities.count()
    print("Assigning activities to TouristicObject.kapt_catalog_activity")
    for process_nb, activity in enumerate(activities, start=1):
        percentage = round(process_nb / nb_activities * 100, 2)
        print(f"{percentage}% - {process_nb}/{nb_activities}")
        apidae_id = activity.structure.reference.former_identifier.split("_")[-1]
        aspect = getattr(activity, "aspect", None)
        touristic_object = TouristicObject.objects.filter(
            apidae_identifier=apidae_id, aspect=aspect
        ).first()

        if touristic_object and touristic_object.kapt_catalog_activity is None:
            touristic_object.kapt_catalog_activity = activity
            touristic_object.save()


class Migration(migrations.Migration):
    dependencies = [
        ("kapt_apidae", "0007_auto_20231215_1736"),
    ]

    operations = [
        migrations.RunPython(forwards_func, migrations.RunPython.noop),
    ]
